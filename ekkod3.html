<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>K√ºm√ºlatif Veri Takip Uygulamasƒ±</title>
<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Inter', Arial, sans-serif; padding: 10px; background-color: #f4f7f9; }
.container { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center; }
.data-section { background-color: white; border: 1px solid #ddd; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); width: 100%; max-width: 400px; }
h1 { color: #2c3e50; margin-bottom: 20px; text-align: center; font-size: 24px; }
h3 { color: #34495e; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; margin-top: 0; margin-bottom: 15px; font-size: 18px; }
.button-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
.button-grid button { padding: 15px; font-size: 16px; cursor: pointer; border: none; border-radius: 8px; transition: all 0.2s; font-weight: bold; background-color: #ecf0f1; }
.button-grid button:hover { background-color: #bdc3c7; transform: translateY(-2px); }
.button-grid button:active { transform: translateY(0); }
#save-button { margin-top: 20px; padding: 12px 25px; background-color: #2ecc71; color: white; border: none; border-radius: 8px; cursor: pointer; width: 100%; font-size: 17px; transition: background-color 0.2s; box-shadow: 0 4px #27ae60; }
#save-button:active { box-shadow: 0 1px #27ae60; transform: translateY(3px); }
#chart-button { padding: 12px 25px; background-color: #3498db; color: white; border: none; border-radius: 8px; cursor: pointer; width: 100%; font-size: 17px; transition: background-color 0.2s; box-shadow: 0 4px #2980b9; margin-bottom: 10px; }
#chart-button:active { box-shadow: 0 1px #2980b9; transform: translateY(3px); }
.toggle-button { padding: 10px 20px; background-color: #9b59b6; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; width: 100%; transition: background-color 0.2s; margin-bottom: 10px; }
.toggle-button:hover { background-color: #8e44ad; }
.toggle-button:active { transform: translateY(2px); }
.chart-container { width: 100%; background-color: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; overflow-x: auto; }
.chart-wrapper { position: relative; height: 300px; }
.chart-wrapper.zoom-mode { height: 350px; }
.chart-wrapper.full-mode { height: 400px; }
#current-cumulative-value { font-size: 20px; font-weight: bold; margin-top: 15px; text-align: center; color: #e74c3c; padding: 10px; border: 2px dashed #e74c3c; border-radius: 8px; }
input[type="date"] { padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 6px; width: 100%; margin-bottom: 15px; }
input[type="number"] { padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 6px; width: 100%; margin-bottom: 15px; }
#selected-value { font-size: 20px; color: #2980b9; display: block; margin-bottom: 15px; }
.analysis-container { width: 100%; background-color: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-top: 20px; display: none; }
.analysis-container.visible { display: block; }
.trend-box { background-color: #ecf0f1; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #3498db; font-size: 14px; }
.trend-up { border-left-color: #2ecc71; color: #27ae60; }
.trend-down { border-left-color: #e74c3c; color: #c0392b; }
.chart-title { text-align: center; color: #2c3e50; margin-bottom: 15px; font-size: 16px; }
.bonus-control { background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #ddd; }
.bonus-control label { display: block; font-weight: bold; margin-bottom: 8px; color: #2c3e50; }
.trend-toggle-container { width: 100%; text-align: center; margin-top: 20px; margin-bottom: 20px; }
.trend-toggle-button { padding: 12px 30px; background-color: #e67e22; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; transition: background-color 0.2s; box-shadow: 0 4px #d35400; }
.trend-toggle-button:hover { background-color: #d35400; }
.trend-toggle-button:active { box-shadow: 0 1px #d35400; transform: translateY(3px); }
#special-calc-button { padding: 12px 25px; background-color: #e74c3c; color: white; border: none; border-radius: 8px; cursor: pointer; width: 100%; font-size: 17px; transition: background-color 0.2s; box-shadow: 0 4px #c0392b; margin-bottom: 10px; }
#special-calc-button:hover { background-color: #c0392b; }
#special-calc-button:active { box-shadow: 0 1px #c0392b; transform: translateY(3px); }
.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
.modal-content { background-color: #fefefe; margin: 2% auto; padding: 20px; border-radius: 12px; width: 90%; max-width: 1200px; box-shadow: 0 8px 24px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
.close-modal { color: #aaa; float: right; font-size: 32px; font-weight: bold; cursor: pointer; line-height: 20px; }
.close-modal:hover, .close-modal:focus { color: #000; }
.modal-chart-wrapper { position: relative; height: 400px; margin: 20px 0 50px 0; }
.chart-info-row { display: flex; gap: 15px; justify-content: space-between; margin: 20px 0; }
.chart-info-row .slope-display, .chart-info-row .today-value-display { flex: 1; margin: 0; }
.chart-info-row .s-parameter-control { flex: 0 0 auto; margin: 0; }
.s-parameter-control { background-color: #f8f9fa; padding: 15px; border-radius: 8px; border: 2px solid #3498db; display: flex; align-items: center; gap: 8px; }
.s-parameter-control label { font-weight: bold; color: #2c3e50; font-size: 16px; margin: 0; }
.s-parameter-control input { padding: 8px 12px; font-size: 16px; border: 2px solid #3498db; border-radius: 6px; width: 80px; text-align: center; }
.calc-results { background-color: #ecf0f1; padding: 20px; border-radius: 8px; margin: 20px 0; }
.calc-results h4 { color: #2c3e50; margin-bottom: 15px; }
.calc-item { padding: 10px; margin: 8px 0; background-color: white; border-radius: 6px; border-left: 4px solid #3498db; font-size: 15px; }
.slope-display { background-color: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; font-size: 16px; font-weight: bold; color: #856404; }
.today-value { background-color: #d1ecf1; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #17a2b8; font-size: 16px; font-weight: bold; color: #0c5460; }
.today-value-display { background-color: #d1ecf1; padding: 15px; border-radius: 8px; border-left: 4px solid #17a2b8; font-size: 16px; font-weight: bold; color: #0c5460; }
.date-range-control { display: flex; gap: 10px; align-items: center; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; }
.range-btn { padding: 8px 16px; background-color: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; transition: background-color 0.2s; }
.range-btn:hover { background-color: #2980b9; }
.range-btn:active { transform: translateY(2px); }
#days-range-input { padding: 8px; font-size: 14px; border: 2px solid #3498db; border-radius: 6px; width: 120px; text-align: center; }
.missing-dates-container { background-color: #fff3cd; padding: 20px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #ffc107; }
.missing-dates-list { display: flex; flex-wrap: wrap; gap: 8px; }
.missing-date-item { background-color: white; padding: 6px 12px; border-radius: 4px; font-size: 13px; color: #856404; border: 1px solid #ffc107; }
@media (max-width: 768px) {
.container { flex-direction: column; }
.data-section { max-width: none; }
h1 { font-size: 20px; }
.button-grid button { padding: 12px; font-size: 14px; }
.chart-wrapper { height: 250px; }
.chart-wrapper.zoom-mode { height: 300px; }
.chart-wrapper.full-mode { height: 350px; }
.modal-content { width: 95%; margin: 5% auto; padding: 15px; }
.modal-chart-wrapper { height: 300px; margin: 20px 0 40px 0; }
.chart-info-row { flex-direction: column; }
.s-parameter-control { padding: 10px; justify-content: center; }
.s-parameter-control label { margin-bottom: 0; }
}
</style>
</head>
<body>

<h1>üìÖ K√ºm√ºlatif Veri Kaydedici</h1>

<div class="container">
<div class="data-section">
<h3>Veri Giri≈üi</h3>
<label for="date-picker" style="font-weight: bold;">Tarih Se√ßin:</label>
<input type="date" id="date-picker" required>
<span style="display: block; font-weight: bold;">Se√ßilen Deƒüer:</span> 
<strong id="selected-value">0.00</strong>
<div class="button-grid" id="button-container"></div>
<button id="save-button" onclick="saveData()">üíæ Se√ßilen Deƒüeri Kaydet</button>
<p id="save-status" style="color: #27ae60; font-weight: bold; text-align: center; margin-top: 10px;"></p>
</div>

<div class="data-section">
<h3>Grafik & Analiz</h3>
<button id="chart-button" onclick="generateChart()">üìà Grafiƒüi ≈ûimdi G√ºncelle</button>
<button id="special-calc-button" onclick="openSpecialCalculation()">üî¨ √ñzel Hesaplama Grafiƒüi</button>
<button class="toggle-button" onclick="toggleChartMode()">üìä <span id="mode-text">Normal G√∂r√ºn√ºm</span></button>
<div id="current-cumulative-value"></div>
<div class="bonus-control">
<label for="bonus-input">Grafik 3 & 4 Bonus Deƒüeri:</label>
<input type="number" id="bonus-input" value="0.5" step="0.1" min="0" max="5" onchange="generateChart()">
<p style="font-size: 12px; color: #7f8c8d; margin-top: 5px;">Bu deƒüer 3. ve 4. grafiklere eklenecek</p>
</div>
</div>
</div>

<div class="chart-container">
<h3 class="chart-title">Grafik 1: K√ºm√ºlatif Toplam</h3>
<div class="chart-wrapper" id="wrapper1">
<canvas id="cumulativeChart"></canvas>
</div>
</div>

<div class="chart-container">
<h3 class="chart-title">Grafik 2: G√ºnl√ºk Deƒüerler</h3>
<div class="chart-wrapper" id="wrapper2">
<canvas id="dailyChart"></canvas>
</div>
</div>

<div class="chart-container">
<h3 class="chart-title">Grafik 3: K√ºm√ºlatif Toplam (+Bonus)</h3>
<div class="chart-wrapper" id="wrapper3">
<canvas id="cumulativePlusOneChart"></canvas>
</div>
</div>

<div class="chart-container">
<h3 class="chart-title">Grafik 4: G√ºnl√ºk Deƒüerler (+Bonus)</h3>
<div class="chart-wrapper" id="wrapper4">
<canvas id="dailyPlusOneChart"></canvas>
</div>
</div>

<div class="trend-toggle-container">
<button class="trend-toggle-button" onclick="toggleTrendVisibility()">
üëÅÔ∏è <span id="trend-visibility-text">Trend Analizini G√∂ster</span>
</button>
</div>

<div class="analysis-container" id="analysis-container">
<h3 style="text-align: center; color: #2c3e50; margin-bottom: 20px;">üìä Trend Analizi</h3>
<div id="trend-analysis"></div>
</div>

<!-- √ñzel Hesaplama Modal -->
<div id="special-calc-modal" class="modal">
<div class="modal-content">
<span class="close-modal" onclick="closeSpecialCalculation()">&times;</span>
<h2 style="text-align: center; color: #2c3e50; margin-bottom: 20px;">üî¨ √ñzel Hesaplama Grafiƒüi</h2>
<div class="date-range-control">
<button class="range-btn" onclick="adjustDateRange(-30)">-30 G√ºn</button>
<button class="range-btn" onclick="adjustDateRange(-10)">-10 G√ºn</button>
<input type="number" id="days-range-input" value="0" min="0" placeholder="Son ka√ß g√ºn">
<button class="range-btn" onclick="adjustDateRange(10)">+10 G√ºn</button>
<button class="range-btn" onclick="adjustDateRange(30)">+30 G√ºn</button>
</div>
<div class="modal-chart-wrapper">
<canvas id="specialCalcChart"></canvas>
</div>
<div class="chart-info-row">
<div class="slope-display" id="slope-display"></div>
<div class="today-value-display" id="today-value-display"></div>
</div>
<div class="modal-chart-wrapper" style="margin-top: 30px;">
<canvas id="specialCalcChart2"></canvas>
</div>
<div class="chart-info-row">
<div class="s-parameter-control">
<label for="s-parameter-input">Deƒüer:</label>
<input type="number" id="s-parameter-input" value="12" step="0.1" onchange="renderSpecialCharts()">
</div>
<div class="slope-display" id="slope-display-2"></div>
<div class="today-value-display" id="today-value-display-2"></div>
</div>
<div class="calc-results">
<h4>üìä Bug√ºn√ºn Hesaplamalarƒ±</h4>
<div class="calc-item" id="calc-result-1"></div>
<div class="calc-item" id="calc-result-2"></div>
</div>
<div class="missing-dates-container">
<h4 style="color: #2c3e50; margin-bottom: 15px;">üìÖ Veri Girilmeyen Tarihler</h4>
<div id="missing-dates-list"></div>
</div>
</div>
</div>

<script>
const firebaseConfig = {
apiKey: "AIzaSyAIGzwmEB9F7K7KQzsEU5etVWejZ3oSluc",
authDomain: "paralayici.firebaseapp.com",
projectId: "paralayici",
storageBucket: "paralayici.firebasestorage.app",
messagingSenderId: "980843550614",
appId: "1:980843550614:web:93dd5bda4ddc377b20efb7"
};

let db;
let chartInstance1 = null;
let chartInstance2 = null;
let chartInstance3 = null;
let chartInstance4 = null;
let specialChartInstance = null;
let specialChartInstance2 = null;
let chartMode = 0;
let trendVisible = false;
let currentDaysRange = 0;
let allSpecialData = null;

const buttonValues = [-1.25, -0.25, 0.75, -1, 0, 1, -0.75, 0.25, 1.25];
let selectedValue = 0;
const collectionName = "cumulative_daily_data";

try {
firebase.initializeApp(firebaseConfig);
db = firebase.firestore();
console.log("Firebase ba≈üarƒ±yla ba≈ülatƒ±ldƒ±.");
document.getElementById('date-picker').valueAsDate = new Date();
} catch (e) {
console.error("Firebase ba≈ülatƒ±lƒ±rken kritik hata:", e);
document.body.innerHTML = "<h1>Hata</h1><p>Firebase yapƒ±landƒ±rma bilgileri yanlƒ±≈ü veya eksik.</p>";
}

function setupButtons() {
const container = document.getElementById('button-container');
container.innerHTML = '';
buttonValues.forEach(value => {
const button = document.createElement('button');
button.textContent = value.toFixed(2);
button.onclick = () => selectValue(value);
container.appendChild(button);
});
}

function selectValue(value) {
selectedValue = value;
document.getElementById('selected-value').textContent = value.toFixed(2);
}

function alertMessage(message, color) {
const statusElement = document.getElementById('save-status');
statusElement.textContent = message;
statusElement.style.color = color;
setTimeout(() => statusElement.textContent = '', 4000);
}

async function saveData() {
if (!db) return alertMessage("Firebase ba≈ülatƒ±lamadƒ±.", 'red');
const dateInput = document.getElementById('date-picker');
const date = dateInput.value;
if (!date) {
alertMessage("L√ºtfen bir tarih se√ßin.", 'red');
return;
}
try {
await db.collection(collectionName).doc(date).set({
date: date,
value: selectedValue,
timestamp: firebase.firestore.FieldValue.serverTimestamp()
});
alertMessage(`‚úÖ ${date} i√ßin ${selectedValue.toFixed(2)} kaydedildi!`, 'green');
generateChart();
} catch (error) {
console.error("Veri kaydederken hata olu≈ütu: ", error);
alertMessage(`‚ùå Kayƒ±t hatasƒ±: Baƒülantƒ± veya yetkilendirme sorunu.`, 'red');
}
}

function toggleChartMode() {
chartMode = (chartMode + 1) % 3;
const modeText = document.getElementById('mode-text');
if (chartMode === 0) {
modeText.textContent = 'Normal G√∂r√ºn√ºm';
} else if (chartMode === 1) {
modeText.textContent = 'Yakƒ±n G√∂r√ºn√ºm';
} else {
modeText.textContent = 'Uzak G√∂r√ºn√ºm';
}
generateChart();
}

function toggleTrendVisibility() {
trendVisible = !trendVisible;
const container = document.getElementById('analysis-container');
const buttonText = document.getElementById('trend-visibility-text');
if (trendVisible) {
container.classList.add('visible');
buttonText.textContent = 'Trend Analizini Gizle';
} else {
container.classList.remove('visible');
buttonText.textContent = 'Trend Analizini G√∂ster';
}
}

function calculateTrend(data) {
if (data.length < 2) return { direction: 'neutral', percentage: 0 };
const sum = data.reduce((a, b) => a + b, 0);
const avg = sum / data.length;
const recentSum = data.slice(-Math.max(1, Math.floor(data.length / 2))).reduce((a, b) => a + b, 0);
const recentAvg = recentSum / Math.max(1, Math.floor(data.length / 2));
const change = ((recentAvg - avg) / Math.abs(avg || 1)) * 100;
if (Math.abs(change) < 5) return { direction: 'stable', percentage: change };
return { direction: change > 0 ? 'up' : 'down', percentage: change };
}

function analyzeTrends(dailyValues) {
const n = dailyValues.length;
if (n < 2) return '<p style="text-align: center; color: #7f8c8d;">Trend analizi i√ßin yeterli veri yok.</p>';

const half = Math.floor(n / 2);
const quarter = Math.floor(n / 4);
const sixteenth = Math.floor(n / 16);

const fullData = dailyValues;
const lastHalf = dailyValues.slice(-half);
const lastQuarter = dailyValues.slice(-quarter);
const lastSixteenth = sixteenth > 0 ? dailyValues.slice(-sixteenth) : dailyValues.slice(-1);

const fullTrend = calculateTrend(fullData);
const halfTrend = calculateTrend(lastHalf);
const quarterTrend = calculateTrend(lastQuarter);
const sixteenthTrend = calculateTrend(lastSixteenth);

function getTrendText(trend, label) {
let icon = 'üìä';
let className = '';
let text = '';
if (trend.direction === 'up') {
icon = 'üìà';
className = 'trend-up';
text = `<strong>${label}:</strong> Artƒ±≈ü trendinde (${trend.percentage.toFixed(1)}% y√ºkseli≈ü)`;
} else if (trend.direction === 'down') {
icon = 'üìâ';
className = 'trend-down';
text = `<strong>${label}:</strong> Azalƒ±≈ü trendinde (${Math.abs(trend.percentage).toFixed(1)}% d√º≈ü√º≈ü)`;
} else {
icon = '‚û°Ô∏è';
text = `<strong>${label}:</strong> Stabil trend (${trend.percentage.toFixed(1)}% deƒüi≈üim)`;
}
return `<div class="trend-box ${className}">${icon} ${text}</div>`;
}

return `
${getTrendText(fullTrend, 'T√ºm Veriler')}
${getTrendText(halfTrend, `Son Yarƒ± (${half} g√ºn)`)}
${getTrendText(quarterTrend, `Son √áeyrek (${quarter} g√ºn)`)}
${getTrendText(sixteenthTrend, `Son 1/16 (${lastSixteenth.length} g√ºn)`)}
`;
}

async function generateChart() {
if (!db) return;

const snapshot = await db.collection(collectionName).orderBy("date", "asc").get();

if (snapshot.empty) {
if (chartInstance1) chartInstance1.destroy();
if (chartInstance2) chartInstance2.destroy();
if (chartInstance3) chartInstance3.destroy();
if (chartInstance4) chartInstance4.destroy();
document.getElementById('current-cumulative-value').innerHTML = '**Bug√ºnk√º K√ºm√ºlatif Deƒüer:** 0.00 (Veri Yok)';
document.getElementById('trend-analysis').innerHTML = '<p style="text-align: center; color: #7f8c8d;">Veri yok.</p>';
return;
}

const bonusValue = parseFloat(document.getElementById('bonus-input').value) || 0.5;

const allData = [];
snapshot.forEach(doc => allData.push(doc.data()));

let cumulativeSum = 0;
let cumulativeSumPlusBonus = 0;
const labels = [];
const dailyValues = [];
const cumulativeData = [];
const dailyPlusBonusValues = [];
const cumulativePlusBonusData = [];

allData.forEach(item => {
cumulativeSum += item.value;
cumulativeSumPlusBonus += (item.value + bonusValue);
labels.push(item.date);
dailyValues.push(item.value);
cumulativeData.push(cumulativeSum);
dailyPlusBonusValues.push(item.value + bonusValue);
cumulativePlusBonusData.push(cumulativeSumPlusBonus);
});

const finalCumulativeValue = cumulativeSum.toFixed(2);
document.getElementById('current-cumulative-value').innerHTML = `**Bug√ºnk√º K√ºm√ºlatif Deƒüer:** ${finalCumulativeValue}`;

document.getElementById('trend-analysis').innerHTML = analyzeTrends(dailyValues);

const wrappers = document.querySelectorAll('.chart-wrapper');
wrappers.forEach(wrapper => {
wrapper.classList.remove('zoom-mode', 'full-mode');
if (chartMode === 1) wrapper.classList.add('zoom-mode');
if (chartMode === 2) wrapper.classList.add('full-mode');
});

const baseOptions = {
responsive: true,
maintainAspectRatio: true,
plugins: {
legend: { display: false }
},
scales: {
x: {
title: { display: true, text: 'Tarih', font: { size: 12 } },
grid: { display: false }
},
y: {
title: { display: true, text: 'Deƒüer', font: { size: 12 } },
beginAtZero: false
}
}
};

let chartOptions = JSON.parse(JSON.stringify(baseOptions));

if (chartMode === 1) {
const recentCount = Math.min(14, labels.length);
chartOptions.scales.x.min = labels[Math.max(0, labels.length - recentCount)];
chartOptions.scales.x.max = labels[labels.length - 1];
} else if (chartMode === 2) {
chartOptions.scales.x.ticks = { maxTicksLimit: labels.length };
}

if (chartInstance1) chartInstance1.destroy();
const ctx1 = document.getElementById('cumulativeChart').getContext('2d');
chartInstance1 = new Chart(ctx1, {
type: 'line',
data: {
labels: labels,
datasets: [{
label: 'K√ºm√ºlatif Deƒüer',
data: cumulativeData,
borderColor: '#3498db',
backgroundColor: 'rgba(52, 152, 219, 0.2)',
tension: 0.3,
fill: true,
pointRadius: 3,
pointBackgroundColor: '#2ecc71',
borderWidth: 2
}]
},
options: chartOptions
});

if (chartInstance2) chartInstance2.destroy();
const ctx2 = document.getElementById('dailyChart').getContext('2d');
chartInstance2 = new Chart(ctx2, {
type: 'bar',
data: {
labels: labels,
datasets: [{
label: 'G√ºnl√ºk Deƒüer',
data: dailyValues,
backgroundColor: dailyValues.map(v => v >= 0 ? 'rgba(46, 204, 113, 0.6)' : 'rgba(231, 76, 60, 0.6)'),
borderColor: dailyValues.map(v => v >= 0 ? '#2ecc71' : '#e74c3c'),
borderWidth: 2
}]
},
options: JSON.parse(JSON.stringify(chartOptions))
});

if (chartInstance3) chartInstance3.destroy();
const ctx3 = document.getElementById('cumulativePlusOneChart').getContext('2d');
chartInstance3 = new Chart(ctx3, {
type: 'line',
data: {
labels: labels,
datasets: [{
label: 'K√ºm√ºlatif Deƒüer (+Bonus)',
data: cumulativePlusBonusData,
borderColor: '#9b59b6',
backgroundColor: 'rgba(155, 89, 182, 0.2)',
tension: 0.3,
fill: true,
pointRadius: 3,
pointBackgroundColor: '#8e44ad',
borderWidth: 2
}]
},
options: JSON.parse(JSON.stringify(chartOptions))
});

if (chartInstance4) chartInstance4.destroy();
const ctx4 = document.getElementById('dailyPlusOneChart').getContext('2d');
chartInstance4 = new Chart(ctx4, {
type: 'bar',
data: {
labels: labels,
datasets: [{
label: 'G√ºnl√ºk Deƒüer (+Bonus)',
data: dailyPlusBonusValues,
backgroundColor: dailyPlusBonusValues.map(v => v >= 0 ? 'rgba(46, 204, 113, 0.6)' : 'rgba(231, 76, 60, 0.6)'),
borderColor: dailyPlusBonusValues.map(v => v >= 0 ? '#2ecc71' : '#e74c3c'),
borderWidth: 2
}]
},
options: JSON.parse(JSON.stringify(chartOptions))
});
}

function sign(x) {
if (x > 0) return 1;
if (x < 0) return -1;
return 0;
}

async function openSpecialCalculation() {
if (!db) {
alert("Firebase ba≈ülatƒ±lamadƒ±.");
return;
}

const snapshot = await db.collection(collectionName).orderBy("date", "asc").get();

if (snapshot.empty) {
alert("Veri yok. √ñnce veri girin.");
return;
}

const allData = [];
snapshot.forEach(doc => allData.push(doc.data()));

// ƒ∞lk tarihi belirle
const firstDate = new Date(allData[0].date);
const today = new Date();

// T√ºm tarihleri olu≈ütur (ilk tarihten bug√ºne)
const allDates = [];
const dateMap = new Map();
allData.forEach(item => dateMap.set(item.date, item.value));

let currentDate = new Date(firstDate);
while (currentDate <= today) {
const dateStr = currentDate.toISOString().split('T')[0];
allDates.push(dateStr);
currentDate.setDate(currentDate.getDate() + 1);
}

const labels = [];
const calculatedValues = [];
const calculatedValues2 = [];
const missingDates = [];
let Tp = 0; // Toplam puan
let Bg = 0; // Bo≈ü g√ºn sayƒ±sƒ±

for (let i = 0; i < allDates.length; i++) {
const date = allDates[i];
const Tg = i + 1; // Toplam g√ºn sayƒ±sƒ±
const value = dateMap.get(date);

if (value !== undefined) {
Tp += value;
} else {
Bg++;
missingDates.push(date);
}

// Denklem 1: 100*sign(((2843+4*(Tp+(Tg-Bg))+(Bg*(0.5)))/365))*(abs(((2843+4*(Tp+(Tg-Bg))+(Bg*(0.5)))/365)/(4*((990+Tg)/365)))^(1.62)) / (1 + abs((((2843+4*(Tp+(Tg-Bg))+(Bg*(0.5)))/365)/(4*((990+Tg)/365)))^(0.62) - 1)))
const numerator = 2843 + 4 * (Tp + (Tg - Bg)) + (Bg * 0.5);
const numeratorDiv365 = numerator / 365;
const denomBase = 4 * ((990 + Tg) / 365);
const ratio = numeratorDiv365 / denomBase;
const absRatio = Math.abs(ratio);
const term1 = Math.pow(absRatio, 1.62);
const term2 = Math.pow(absRatio, 0.62);
const denominator = 1 + Math.abs(term2 - 1);
const result = 100 * sign(numeratorDiv365) * (term1 / denominator);

// Denklem 2: (s*(‚àí((990+Tg)/365)*sin(arctan(4))+((2843+4*(Tp+(Tg-Bg))+(Bg*(0.5)))/365)*cos(arctan(4))))
// x = ((990+Tg)/365)
// y = ((2843+4*(Tp+(Tg-Bg))+(Bg*(0.5)))/365)
const x = (990 + Tg) / 365;
const y = (2843 + 4 * (Tp + (Tg - Bg)) + (Bg * 0.5)) / 365;
const result2_base_x = x;
const result2_base_y = y;

labels.push(date);
calculatedValues.push(result);
calculatedValues2.push({ x: result2_base_x, y: result2_base_y }); // x ve y'yi sakla
}

// Verileri global deƒüi≈ükene kaydet
allSpecialData = {
labels: labels,
calculatedValues: calculatedValues,
calculatedValues2: calculatedValues2,
missingDates: missingDates,
finalTg: allDates.length,
finalTp: Tp,
finalBg: Bg
};

// Ba≈ülangƒ±√ßta t√ºm veriyi g√∂ster
currentDaysRange = 0;
document.getElementById('days-range-input').value = 0;

// Modal'ƒ± a√ß
document.getElementById('special-calc-modal').style.display = 'block';

// Grafikleri √ßiz
renderSpecialCharts();
}

function renderSpecialCharts() {
if (!allSpecialData) return;

const { labels, calculatedValues, calculatedValues2, missingDates, finalTg, finalTp, finalBg } = allSpecialData;

// S parametresini al
const S = parseFloat(document.getElementById('s-parameter-input').value) || 12;

// calculatedValues2'deki x ve y deƒüerlerini kullanarak ger√ßek deƒüerleri hesapla
// Yeni form√ºl: (s*(‚àí((990+Tg)/365)*sin(arctan(4))+((2843+4*(Tp+(Tg-Bg))+(Bg*(0.5)))/365)*cos(arctan(4))))
const actualValues2 = calculatedValues2.map(item => {
const arctan4 = Math.atan(4);
return S * (-(item.x * Math.sin(arctan4)) + (item.y * Math.cos(arctan4)));
});

// Tarih aralƒ±ƒüƒ±na g√∂re veriyi filtrele
let displayLabels = labels;
let displayValues = calculatedValues;
let displayValues2 = actualValues2;

if (currentDaysRange > 0 && currentDaysRange < labels.length) {
displayLabels = labels.slice(-currentDaysRange);
displayValues = calculatedValues.slice(-currentDaysRange);
displayValues2 = actualValues2.slice(-currentDaysRange);
}

// Tarihleri formatla (g√ºn.ay.yƒ±l formatƒ±nda)
const formattedLabels = displayLabels.map(date => {
const d = new Date(date);
const day = String(d.getDate()).padStart(2, '0');
const month = String(d.getMonth() + 1).padStart(2, '0');
const year = String(d.getFullYear()).slice(-2);
return `${day}.${month}.${year}`;
});

// Eƒüim hesaplama (g√∂r√ºnt√ºlenen veri i√ßin)
const firstValue = displayValues[0];
const lastValue = displayValues[displayValues.length - 1];
const slope = ((lastValue - firstValue) / displayValues.length).toFixed(4);

const firstValue2 = displayValues2[0];
const lastValue2 = displayValues2[displayValues2.length - 1];
const slope2 = ((lastValue2 - firstValue2) / displayValues2.length).toFixed(4);

// Bug√ºn√ºn deƒüerleri (her zaman son deƒüer)
const todayValue = calculatedValues[calculatedValues.length - 1].toFixed(4);
const todayValue2 = actualValues2[actualValues2.length - 1].toFixed(4);

// Bug√ºn i√ßin iki ek hesaplama
const lastData = calculatedValues2[calculatedValues2.length - 1];
const arctan4 = Math.atan(4);
const todayCalc1 = Math.round(S * (-(lastData.x * Math.sin(arctan4)) + (lastData.y * Math.cos(arctan4))) * 100) / 100;
const todayCalc2 = Math.round(S * ((lastData.x * Math.cos(arctan4)) + (lastData.y * Math.sin(arctan4))) * 100) / 100;

// Hesaplamalarƒ± g√∂ster
const calc1 = ((990 + finalTg) / 365).toFixed(4);
const calc2 = ((2843 + 4 * (finalTp + (finalTg - finalBg)) + (finalBg * 0.5)) / 365).toFixed(4);

document.getElementById('slope-display').innerHTML = `üìà Eƒüim (G√∂r√ºnt√ºlenen Aralƒ±k): <strong>${slope}</strong>`;
document.getElementById('today-value-display').innerHTML = `üìÖ Bug√ºn√ºn Deƒüeri: <strong>${todayValue}</strong>`;
document.getElementById('slope-display-2').innerHTML = `üìà Eƒüim (G√∂r√ºnt√ºlenen Aralƒ±k): <strong>${slope2}</strong>`;
document.getElementById('today-value-display-2').innerHTML = `üìÖ Bug√ºn√ºn Deƒüerleri: <strong>${todayCalc1}</strong> , <strong>${todayCalc2}</strong>`;
document.getElementById('calc-result-1').innerHTML = `<strong>${calc1}</strong>`;
document.getElementById('calc-result-2').innerHTML = `<strong>${calc2}</strong>`;

// Eksik tarihleri g√∂ster
const missingDatesHtml = missingDates.length > 0 
? missingDates.map(date => {
const d = new Date(date);
return `<span class="missing-date-item">${d.getDate()}.${d.getMonth() + 1}.${d.getFullYear()}</span>`;
}).join('')
: '<p style="text-align: center; color: #27ae60;">T√ºm g√ºnlere veri girilmi≈ü! üéâ</p>';
document.getElementById('missing-dates-list').innerHTML = missingDatesHtml;

// Grafik 1 olu≈ütur
if (specialChartInstance) specialChartInstance.destroy();
const ctx = document.getElementById('specialCalcChart').getContext('2d');
specialChartInstance = new Chart(ctx, {
type: 'line',
data: {
labels: formattedLabels,
datasets: [{
label: 'Grafik 1 Deƒüeri',
data: displayValues,
borderColor: '#e74c3c',
backgroundColor: 'rgba(231, 76, 60, 0.2)',
tension: 0.3,
fill: true,
pointRadius: 2,
pointBackgroundColor: '#c0392b',
borderWidth: 2
}]
},
options: {
responsive: true,
maintainAspectRatio: true,
plugins: {
legend: { display: true }
},
scales: {
x: {
title: { display: true, text: 'Tarih', font: { size: 12 } },
grid: { display: false },
ticks: {
maxRotation: 45,
minRotation: 45,
autoSkip: true,
maxTicksLimit: 20
}
},
y: {
title: { display: true, text: 'Deƒüer', font: { size: 12 } },
beginAtZero: false
}
}
}
});

// Grafik 2 olu≈ütur
if (specialChartInstance2) specialChartInstance2.destroy();
const ctx2 = document.getElementById('specialCalcChart2').getContext('2d');
specialChartInstance2 = new Chart(ctx2, {
type: 'line',
data: {
labels: formattedLabels,
datasets: [{
label: 'Grafik 2 Deƒüeri',
data: displayValues2,
borderColor: '#9b59b6',
backgroundColor: 'rgba(155, 89, 182, 0.2)',
tension: 0.3,
fill: true,
pointRadius: 2,
pointBackgroundColor: '#8e44ad',
borderWidth: 2
}]
},
options: {
responsive: true,
maintainAspectRatio: true,
plugins: {
legend: { display: true }
},
scales: {
x: {
title: { display: true, text: 'Tarih', font: { size: 12 } },
grid: { display: false },
ticks: {
maxRotation: 45,
minRotation: 45,
autoSkip: true,
maxTicksLimit: 20
}
},
y: {
title: { display: true, text: 'Deƒüer', font: { size: 12 } },
beginAtZero: false
}
}
}
});
}

function adjustDateRange(delta) {
const input = document.getElementById('days-range-input');
let newValue = parseInt(input.value) || 0;
newValue += delta;
if (newValue < 0) newValue = 0;
if (allSpecialData && newValue > allSpecialData.labels.length) {
newValue = allSpecialData.labels.length;
}
input.value = newValue;
applyDateRange();
}

function applyDateRange() {
const input = document.getElementById('days-range-input');
currentDaysRange = parseInt(input.value) || 0;
if (currentDaysRange < 0) currentDaysRange = 0;
if (allSpecialData && currentDaysRange > allSpecialData.labels.length) {
currentDaysRange = allSpecialData.labels.length;
}
renderSpecialCharts();
}

function closeSpecialCalculation() {
document.getElementById('special-calc-modal').style.display = 'none';
}

// Modal dƒ±≈üƒ±na tƒ±klandƒ±ƒüƒ±nda kapat
window.onclick = function(event) {
const modal = document.getElementById('special-calc-modal');
if (event.target == modal) {
modal.style.display = 'none';
}
}

window.onload = () => {
setupButtons();
generateChart();
};
</script>

</body>
</html>
