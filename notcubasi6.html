<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finans YÃ¶neticisi</title>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 8px; 
        }
        
        .container { 
            background: white; 
            border-radius: 16px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.15); 
            max-width: 450px; 
            margin: 0 auto;
            overflow: hidden;
        }
        
        .top-bar { 
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%); 
            color: white; 
            padding: 16px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .btn { 
            background: rgba(255,255,255,0.15); 
            border: 1px solid rgba(255,255,255,0.3); 
            color: white; 
            padding: 10px 16px; 
            border-radius: 8px; 
            cursor: pointer; 
            margin: 3px; 
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }
        
        .btn:hover { 
            background: rgba(255,255,255,0.25); 
            transform: translateY(-1px);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        
        .content { padding: 20px; }
        
        .main-buttons { 
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            padding: 16px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .main-btn { 
            flex: 1;
            padding: 14px 8px; 
            font-size: 15px; 
            font-weight: 600;
            border: none; 
            border-radius: 10px; 
            cursor: pointer; 
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .main-btn:active { transform: translateY(1px); }
        
        .calc-btn { 
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); 
            color: white; 
        }
        
        .calc-btn:hover { box-shadow: 0 4px 12px rgba(76,175,80,0.3); }
        
        .settings-btn { 
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); 
            color: white; 
        }
        
        .settings-btn:hover { box-shadow: 0 4px 12px rgba(255,152,0,0.3); }
        
        .work-section { 
            background: linear-gradient(135deg, #e3f2fd 0%, #f1f8ff 100%); 
            padding: 18px; 
            border-radius: 12px; 
            margin-bottom: 20px;
            border: 1px solid rgba(66,165,245,0.2);
        }
        
        .work-section h3 {
            margin-bottom: 16px;
            color: #1976d2;
            font-size: 16px;
            font-weight: 600;
        }
        
        .work-row { 
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 12px 16px;
            align-items: center;
            margin-bottom: 12px; 
        }
        
        .work-row label {
            font-weight: 500;
            color: #555;
            font-size: 14px;
        }
        
        .holiday-row {
            grid-column: 1 / -1;
            text-align: center;
            margin-top: 8px;
        }
        
        .expense-section { 
            background: linear-gradient(135deg, #fff8e1 0%, #fffbf0 100%); 
            padding: 18px; 
            border-radius: 12px;
            border: 1px solid rgba(255,193,7,0.2);
        }
        
        .expense-section h3 {
            margin-bottom: 16px;
            color: #f57c00;
            font-size: 16px;
            font-weight: 600;
        }
        
        .expense-row { 
            display: grid;
            grid-template-columns: auto 1fr 1fr auto;
            gap: 8px;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .expense-list { 
            background: white; 
            border: 2px solid #f5f5f5; 
            border-radius: 10px; 
            min-height: 180px; 
            padding: 12px; 
            margin: 16px 0;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .expense-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            padding: 12px 8px; 
            border-bottom: 1px solid #f0f0f0; 
            cursor: pointer;
            border-radius: 6px;
            margin-bottom: 4px;
            transition: all 0.2s ease;
        }
        
        .expense-item:hover { 
            background: #f8f9fa;
            transform: translateX(4px);
        }
        
        .expense-item.selected { 
            background: linear-gradient(135deg, #e3f2fd 0%, #f1f8ff 100%);
            border-color: #42a5f5;
            box-shadow: 0 2px 8px rgba(66,165,245,0.2);
        }
        
        .expense-amount {
            font-weight: 600;
            color: #d32f2f;
        }
        
        .expense-time {
            font-size: 12px;
            color: #666;
        }
        
        .total { 
            font-weight: 700; 
            font-size: 18px; 
            text-align: center; 
            margin-top: 16px; 
            padding: 12px;
            background: linear-gradient(135deg, #ffebee 0%, #fce4ec 100%);
            color: #c62828; 
            border-radius: 8px;
            border: 1px solid rgba(229,57,53,0.2);
        }
        
        input, select { 
            padding: 12px; 
            border: 2px solid #e1e5e9; 
            border-radius: 8px; 
            font-size: 16px;
            transition: all 0.2s ease;
            background: white;
        }
        
        input:focus, select:focus { 
            outline: none; 
            border-color: #4a90e2; 
            box-shadow: 0 0 0 3px rgba(74,144,226,0.1);
        }
        
        .action-btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
            min-width: 44px;
        }
        
        .add-btn {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            box-shadow: 0 2px 6px rgba(76,175,80,0.2);
        }
        
        .delete-btn {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
            box-shadow: 0 2px 6px rgba(244,67,54,0.2);
        }
        
        .holiday-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(33,150,243,0.2);
        }
        
        .holiday-btn.active {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        }
        
        .work-summary {
            margin-top: 12px;
            padding: 10px;
            background: rgba(255,255,255,0.6);
            border-radius: 6px;
            font-size: 14px;
            color: #555;
        }
        
        .overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.6); 
            display: none; 
            justify-content: center; 
            align-items: center; 
            z-index: 1000;
            backdrop-filter: blur(5px);
            padding: 20px;
        }
        
        .popup { 
            background: white; 
            padding: 24px; 
            border-radius: 16px; 
            width: 100%; 
            max-width: 400px; 
            max-height: 85vh; 
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: popupSlide 0.3s ease-out;
        }
        
        @keyframes popupSlide {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        .popup h3 { 
            margin-bottom: 20px; 
            text-align: center;
            color: #333;
            font-size: 20px;
        }
        
        .popup input, .popup button { 
            margin: 8px 0; 
            width: 100%; 
        }
        
        .popup button { 
            padding: 12px; 
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .popup button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(74,144,226,0.3);
        }
        
        .close-btn { 
            position: absolute;
            top: 16px;
            right: 16px;
            background: #f44336; 
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        
        .popup label {
            display: block;
            margin: 12px 0 4px;
            font-weight: 500;
            color: #555;
        }
        
        .hidden { display: none !important; }
        
        .loading { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            display: flex; 
            flex-direction: column;
            justify-content: center; 
            align-items: center; 
            z-index: 2000; 
            color: white; 
        }
        
        .loading-spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }
        
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        /* Mobile Optimizations */
        @media (max-width: 480px) {
            body { padding: 4px; }
            
            .container { 
                border-radius: 12px;
                max-width: 100%;
            }
            
            .top-bar { 
                padding: 12px 16px;
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .content { padding: 16px; }
            
            .work-row { 
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .work-row label {
                font-size: 13px;
            }
            
            .expense-row { 
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }
            
            .action-btn {
                grid-column: span 2;
                justify-self: center;
                width: 120px;
            }
            
            input, select { 
                font-size: 16px; /* iOS zoom Ã¶nleme */
                padding: 14px;
            }
            
            .main-btn { 
                padding: 16px 8px;
                font-size: 16px;
            }
            
            .expense-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
            
            .popup { padding: 20px; }
        }
        
        /* Dark mode iÃ§in hazÄ±rlÄ±k */
        @media (prefers-color-scheme: dark) {
            /* Gelecekte eklenebilir */
        }
    </style>
</head>
<body>
    <!-- Loading -->
    <div class="loading" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div>Sistem baÅlatÄ±lÄ±yor...</div>
    </div>
    
    <!-- Main Container -->
    <div class="container hidden" id="mainContainer">
        <div class="top-bar">
            <div>
                <button class="btn" id="dateBtn" onclick="toggleDateDropdown()">Tarih SeÃ§ â¼</button>
                <select class="btn" id="dateDropdown" style="display:none;" onchange="selectDate()"></select>
                <button class="btn" onclick="goToToday()">BugÃ¼n</button>
            </div>
            <div>
                <span>ð¤ <span id="userName">KullanÄ±cÄ±</span></span>
                <button class="btn" onclick="logout()">ÃÄ±kÄ±Å</button>
            </div>
        </div>
        
        <div class="content">
            <!-- Ana Butonlar - Her Zaman GÃ¶rÃ¼nÃ¼r -->
            <div class="main-buttons">
                <button class="main-btn calc-btn" onclick="openCalculation()">Hesapla ð</button>
                <button class="main-btn settings-btn" onclick="openSettings()">âï¸</button>
            </div>
            
            <!-- GÃ¼nlÃ¼k Ä°Ã§erik -->
            <div id="dayContent">
                <!-- ÃalÄ±Åma Bilgileri -->
                <div class="work-section">
                    <h3>ð ÃalÄ±Åma Bilgileri</h3>
                    <div class="work-row">
                        <label>GiriÅ:</label>
                        <input type="time" id="startTime" onchange="saveWorkData()">
                        <label>ÃÄ±kÄ±Å:</label>
                        <input type="time" id="endTime" onchange="saveWorkData()">
                        <label>Mola (dk):</label>
                        <input type="number" id="breakTime" min="0" step="0.1" value="0" onchange="saveWorkData()">
                        <div class="holiday-row">
                            <button class="holiday-btn" id="holidayBtn" onclick="toggleHoliday()">BugÃ¼n Ä°zinli</button>
                        </div>
                    </div>
                    <div class="work-summary" id="workSummary"></div>
                </div>
                
                <!-- Harcamalar -->
                <div class="expense-section">
                    <h3>ð° GÃ¼nlÃ¼k Harcamalar</h3>
                    <div class="expense-row">
                        <button class="action-btn add-btn" onclick="addExpense()">ðï¸</button>
                        <input type="number" id="expenseAmount" placeholder="Fiyat" min="0" step="0.01">
                        <input type="text" id="expenseName" placeholder="AÃ§Ä±klama">
                        <button class="action-btn delete-btn" onclick="deleteSelected()">ð§»</button>
                    </div>
                    
                    <div class="expense-list" id="expenseList">
                        <div style="text-align: center; color: #666; padding: 30px;">HenÃ¼z harcama eklenmemiÅ</div>
                    </div>
                    
                    <div class="total" id="dailyTotal">GÃ¼nlÃ¼k Toplam: 0 TL</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Login Popup -->
    <div class="overlay" id="loginOverlay">
        <div class="popup">
            <h3>ð GiriÅ YapÄ±n</h3>
            <input type="email" id="emailInput" placeholder="E-posta">
            <input type="password" id="passwordInput" placeholder="Åifre">
            <button onclick="login()">GiriÅ Yap</button>
            <div id="errorMessage" style="color: red; margin-top: 10px; display: none;"></div>
        </div>
    </div>
    
    <!-- Settings Popup -->
    <div class="overlay" id="settingsOverlay">
        <div class="popup">
            <button class="close-btn" onclick="closeSettings()">â</button>
            <h3>âï¸ Ayarlar</h3>
            <label>AylÄ±k KazanÃ§ (TL):</label>
            <input type="number" id="monthlyIncome" min="0">
            <label>HaftalÄ±k ÃalÄ±Åma Saati:</label>
            <input type="number" id="weeklyHours" min="0" max="168">
            <label>Haftada KaÃ§ GÃ¼n ÃalÄ±ÅÄ±yorsun:</label>
            <input type="number" id="workDaysPerWeek" min="1" max="7" value="5">
            <label>GÃ¼nlÃ¼k Max ÃalÄ±Åma SÃ¼resi (saat):</label>
            <input type="number" id="maxDailyHours" min="0" max="24" value="8">
            <button onclick="saveSettings()">Kaydet</button>
        </div>
    </div>
    
    <!-- Calculation Popup -->
    <div class="overlay" id="calculationOverlay">
        <div class="popup">
            <button class="close-btn" onclick="closeCalculation()">â</button>
            <h3>ð Hesaplama SonuÃ§larÄ±</h3>
            <div id="calculationResults">
                <p>Hesaplama yapÄ±lÄ±yor...</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAIGzwmEB9F7K7KQzsEU5etVWejZ3oSluc",
            authDomain: "paralayici.firebaseapp.com",
            projectId: "paralayici",
            storageBucket: "paralayici.firebasestorage.app",
            messagingSenderId: "980843550614",
            appId: "1:980843550614:web:93dd5bda4ddc377b20efb7"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        let currentUser = null;
        let selectedDate = null;
        let selectedExpenseIndex = -1;
        let currentDayData = { expenses: [], workData: {}, isHoliday: false };
        
        // BaÅlangÄ±Ã§
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => checkAutoLogin(), 1000);
        });
        
        // Otomatik GiriÅ KontrolÃ¼
        async function checkAutoLogin() {
            const savedLogin = localStorage.getItem('finans_login');
            if (savedLogin) {
                try {
                    const loginData = JSON.parse(savedLogin);
                    const userDoc = await db.collection('users').doc(loginData.userId).get();
                    if (userDoc.exists()) {
                        currentUser = { uid: loginData.userId, ...userDoc.data() };
                        showMainApp();
                        return;
                    }
                } catch (error) {
                    localStorage.removeItem('finans_login');
                }
            }
            showLoginPopup();
        }
        
        // Login Ä°Ålemi
        async function login() {
            const email = document.getElementById('emailInput').value.trim();
            const password = document.getElementById('passwordInput').value.trim();
            
            if (!email || !password) {
                showError('E-posta ve Åifre gerekli!');
                return;
            }
            
            try {
                const usersSnapshot = await db.collection('users')
                    .where('email', '==', email)
                    .where('password', '==', password)
                    .get();
                
                if (usersSnapshot.empty) {
                    showError('E-posta veya Åifre hatalÄ±!');
                    return;
                }
                
                const userDoc = usersSnapshot.docs[0];
                currentUser = { uid: userDoc.id, ...userDoc.data() };
                
                localStorage.setItem('finans_login', JSON.stringify({
                    userId: userDoc.id,
                    email: email
                }));
                
                showMainApp();
            } catch (error) {
                showError('BaÄlantÄ± hatasÄ±!');
            }
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        function logout() {
            if (confirm('ÃÄ±kÄ±Å yapmak istediÄinizden emin misiniz?')) {
                localStorage.removeItem('finans_login');
                currentUser = null;
                showLoginPopup();
            }
        }
        
        function showLoginPopup() {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('loginOverlay').style.display = 'flex';
            document.getElementById('mainContainer').classList.add('hidden');
        }
        
        function showMainApp() {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainContainer').classList.remove('hidden');
            document.getElementById('userName').textContent = currentUser.username || currentUser.email;
            loadDateOptions();
            
            // Otomatik olarak bugÃ¼nÃ¼ gÃ¶ster
            goToToday();
        }
        
        // Tarih SeÃ§imi
        function loadDateOptions() {
            const dropdown = document.getElementById('dateDropdown');
            dropdown.innerHTML = '';
            
            for (let i = 0; i < 30; i++) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const option = document.createElement('option');
                option.value = date.toISOString().split('T')[0];
                option.textContent = date.toLocaleDateString('tr-TR');
                dropdown.appendChild(option);
            }
        }
        
        function toggleDateDropdown() {
            const dropdown = document.getElementById('dateDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }
        
        function selectDate() {
            const dropdown = document.getElementById('dateDropdown');
            selectedDate = dropdown.value;
            document.getElementById('dateBtn').textContent = new Date(selectedDate).toLocaleDateString('tr-TR');
            dropdown.style.display = 'none';
            
            loadDayData();
        }
        
        function goToToday() {
            const today = new Date().toISOString().split('T')[0];
            selectedDate = today;
            document.getElementById('dateBtn').textContent = new Date(today).toLocaleDateString('tr-TR');
            document.getElementById('dateDropdown').style.display = 'none';
            
            loadDayData();
        }
        
        // GÃ¼nlÃ¼k Veri YÃ¼kleme
        async function loadDayData() {
            if (!selectedDate) return;
            
            try {
                const dayDoc = await db.collection('users').doc(currentUser.uid)
                    .collection('daily').doc(selectedDate).get();
                
                if (dayDoc.exists()) {
                    currentDayData = dayDoc.data();
                } else {
                    currentDayData = { expenses: [], workData: {}, isHoliday: false };
                }
                
                updateWorkUI();
                updateExpenseList();
                
            } catch (error) {
                console.error('Veri yÃ¼kleme hatasÄ±:', error);
            }
        }
        
        // ÃalÄ±Åma Verileri
        function updateWorkUI() {
            const workData = currentDayData.workData || {};
            document.getElementById('startTime').value = workData.startTime || '';
            document.getElementById('endTime').value = workData.endTime || '';
            document.getElementById('breakTime').value = workData.breakTime || 0;
            
            const holidayBtn = document.getElementById('holidayBtn');
            if (currentDayData.isHoliday) {
                holidayBtn.textContent = 'â Ä°zinli GÃ¼n';
                holidayBtn.classList.add('active');
            } else {
                holidayBtn.textContent = 'BugÃ¼n Ä°zinli';
                holidayBtn.classList.remove('active');
            }
            
            updateWorkSummary();
        }
        
        function updateWorkSummary() {
            const workData = currentDayData.workData || {};
            const summaryDiv = document.getElementById('workSummary');
            
            if (currentDayData.isHoliday) {
                summaryDiv.innerHTML = '<p style="color: #4caf50;">ðï¸ Bu gÃ¼n izinli olarak iÅaretlenmiÅ</p>';
                return;
            }
            
            if (workData.startTime && workData.endTime) {
                const start = new Date(`2000-01-01T${workData.startTime}`);
                const end = new Date(`2000-01-01T${workData.endTime}`);
                const breakMinutes = parseInt(workData.breakTime) || 0;
                
                const diffMs = end - start - (breakMinutes * 60000);
                const totalMinutes = Math.floor(diffMs / 60000);
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                
                summaryDiv.innerHTML = `<p>â±ï¸ Toplam ÃalÄ±Åma: ${hours}s ${minutes}dk (${breakMinutes}dk mola)</p>`;
            } else {
                summaryDiv.innerHTML = '<p style="color: #666;">ÃalÄ±Åma saatleri girilmemiÅ</p>';
            }
        }
        
        async function saveWorkData() {
            const workData = {
                startTime: document.getElementById('startTime').value,
                endTime: document.getElementById('endTime').value,
                breakTime: parseFloat(document.getElementById('breakTime').value) || 0
            };
            
            currentDayData.workData = workData;
            updateWorkSummary();
            await saveDayData();
        }
        
        async function toggleHoliday() {
            currentDayData.isHoliday = !currentDayData.isHoliday;
            updateWorkUI();
            await saveDayData();
        }
        
        // Harcama Ä°Ålemleri
        function addExpense() {
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const name = document.getElementById('expenseName').value.trim();
            
            if (!amount || amount <= 0) {
                alert('GeÃ§erli bir fiyat girin!');
                return;
            }
            
            const expense = {
                amount: amount,
                name: name || 'Harcama',
                timestamp: new Date().toISOString()
            };
            
            currentDayData.expenses.push(expense);
            
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseName').value = '';
            
            updateExpenseList();
            saveDayData();
        }
        
        function updateExpenseList() {
            const listDiv = document.getElementById('expenseList');
            const expenses = currentDayData.expenses || [];
            
            if (expenses.length === 0) {
                listDiv.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">HenÃ¼z harcama eklenmemiÅ</div>';
                document.getElementById('dailyTotal').textContent = 'GÃ¼nlÃ¼k Toplam: 0 TL';
                return;
            }
            
            let html = '';
            let total = 0;
            
            expenses.forEach((expense, index) => {
                total += expense.amount;
                html += `
                    <div class="expense-item ${selectedExpenseIndex === index ? 'selected' : ''}" 
                         onclick="selectExpense(${index})">
                        <div>
                            <span class="expense-amount">${expense.amount.toFixed(2)} TL</span>
                            <span> - ${expense.name}</span>
                        </div>
                        <span class="expense-time">${new Date(expense.timestamp).toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'})}</span>
                    </div>
                `;
            });
            
            listDiv.innerHTML = html;
            document.getElementById('dailyTotal').textContent = `GÃ¼nlÃ¼k Toplam: ${total.toFixed(2)} TL`;
        }
        
        function selectExpense(index) {
            selectedExpenseIndex = selectedExpenseIndex === index ? -1 : index;
            updateExpenseList();
        }
        
        function deleteSelected() {
            if (selectedExpenseIndex === -1) {
                alert('Silmek iÃ§in Ã¶nce bir harcama seÃ§in!');
                return;
            }
            
            if (confirm('SeÃ§ili harcamayÄ± silmek istediÄinizden emin misiniz?')) {
                currentDayData.expenses.splice(selectedExpenseIndex, 1);
                selectedExpenseIndex = -1;
                updateExpenseList();
                saveDayData();
            }
        }
        
        // Veri Kaydetme
        async function saveDayData() {
            if (!selectedDate) return;
            
            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('daily').doc(selectedDate).set(currentDayData);
            } catch (error) {
                console.error('Veri kaydetme hatasÄ±:', error);
                alert('Veriler kaydedilemedi!');
            }
        }
        
        // Ayarlar
        async function openSettings() {
            document.getElementById('settingsOverlay').style.display = 'flex';
            
            try {
                const settingsDoc = await db.collection('users').doc(currentUser.uid).get();
                const settings = settingsDoc.data().settings || {};
                
                document.getElementById('monthlyIncome').value = settings.monthlyIncome || '';
                document.getElementById('weeklyHours').value = settings.weeklyHours || '';
                document.getElementById('workDaysPerWeek').value = settings.workDaysPerWeek || 5;
                document.getElementById('maxDailyHours').value = settings.maxDailyHours || 8;
            } catch (error) {
                console.error('Ayarlar yÃ¼kleme hatasÄ±:', error);
            }
        }
        
        function closeSettings() {
            document.getElementById('settingsOverlay').style.display = 'none';
        }
        
        async function saveSettings() {
            const settings = {
                monthlyIncome: parseFloat(document.getElementById('monthlyIncome').value) || 0,
                weeklyHours: parseFloat(document.getElementById('weeklyHours').value) || 0,
                workDaysPerWeek: parseInt(document.getElementById('workDaysPerWeek').value) || 5,
                maxDailyHours: parseFloat(document.getElementById('maxDailyHours').value) || 8
            };
            
            try {
                await db.collection('users').doc(currentUser.uid).update({ settings });
                alert('Ayarlar kaydedildi!');
                closeSettings();
            } catch (error) {
                console.error('Ayar kaydetme hatasÄ±:', error);
                alert('Ayarlar kaydedilemedi!');
            }
        }
        
        // Hesaplama
        async function openCalculation() {
            document.getElementById('calculationOverlay').style.display = 'flex';
            
            try {
                // KullanÄ±cÄ± ayarlarÄ±nÄ± al
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                const settings = userDoc.data().settings || {};
                
                // Bu ayÄ±n verilerini al
                const currentMonth = new Date().toISOString().slice(0, 7);
                const dailyDocs = await db.collection('users').doc(currentUser.uid)
                    .collection('daily')
                    .where('__name__', '>=', currentMonth)
                    .where('__name__', '<', currentMonth + '-32')
                    .get();
                
                let monthlyExpenses = 0;
                let dailyExpenses = 0;
                const todayStr = new Date().toISOString().split('T')[0];
                
                dailyDocs.forEach(doc => {
                    const data = doc.data();
                    const expenses = data.expenses || [];
                    const dayTotal = expenses.reduce((sum, exp) => sum + exp.amount, 0);
                    monthlyExpenses += dayTotal;
                    
                    if (doc.id === todayStr) {
                        dailyExpenses = dayTotal;
                    }
                });
                
                // Hesaplamalar
                const monthlyIncome = settings.monthlyIncome || 0;
                const dailyIncome = monthlyIncome / 30;
                
                const dailyPercentage = monthlyIncome > 0 ? (dailyExpenses / dailyIncome * 100).toFixed(2) : 0;
                const monthlyPercentage = monthlyIncome > 0 ? (monthlyExpenses / monthlyIncome * 100).toFixed(2) : 0;
                
                document.getElementById('calculationResults').innerHTML = `
                    <div style="text-align: left;">
                        <h4>ð GÃ¼nlÃ¼k Durum</h4>
                        <p>â¢ BugÃ¼n harcanan: ${dailyExpenses.toFixed(2)} TL</p>
                        <p>â¢ GÃ¼nlÃ¼k kazanÃ§: ${dailyIncome.toFixed(2)} TL</p>
                        <p>â¢ GÃ¼nlÃ¼k kazancÄ±n <strong>%${dailyPercentage}</strong>'ini harcadÄ±n</p>
                        
                        <h4 style="margin-top: 15px;">ð AylÄ±k Durum</h4>
                        <p>â¢ Bu ay harcanan: ${monthlyExpenses.toFixed(2)} TL</p>
                        <p>â¢ AylÄ±k kazanÃ§: ${monthlyIncome.toFixed(2)} TL</p>
                        <p>â¢ AylÄ±k kazancÄ±n <strong>%${monthlyPercentage}</strong>'ini harcadÄ±n</p>
                        
                        <h4 style="margin-top: 15px;">ð¡ Ãneri</h4>
                        <p>${monthlyPercentage > 80 ? 'â ï¸ HarcamalarÄ±nÄ± kontrol et!' : monthlyPercentage > 50 ? 'â¡ Dikkatli ol!' : 'â Ä°yi gidiyorsun!'}</p>
                    </div>
                `;
                
            } catch (error) {
                document.getElementById('calculationResults').innerHTML = '<p style="color: red;">Hesaplama hatasÄ±!</p>';
            }
        }
        
        function closeCalculation() {
            document.getElementById('calculationOverlay').style.display = 'none';
        }
        
        // Enter tuÅu desteÄi
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (document.getElementById('loginOverlay').style.display === 'flex') {
                    login();
                } else if (document.getElementById('expenseAmount') === document.activeElement || 
                          document.getElementById('expenseName') === document.activeElement) {
                    addExpense();
                }
            }
        });
    </script>
</body>
</html>
