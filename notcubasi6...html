<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finans Y√∂neticisi</title>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 8px; padding-top: 60px; }
        .container { background: white; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.15); max-width: 450px; margin: 0 auto; overflow: hidden; }
        .top-bar { background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%); color: white; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: fixed; top: 8px; left: 50%; transform: translateX(-50%); width: calc(min(450px, 100% - 16px)); border-radius: 16px 16px 0 0; z-index: 1000; }
        .left-controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        .user-section { display: flex; align-items: center; gap: 8px; min-width: 0; }
        .user-name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px; }
        .btn { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500; transition: all 0.2s ease; backdrop-filter: blur(10px); }
        .btn:hover { background: rgba(255,255,255,0.25); transform: translateY(-1px); }
        .content { padding: 16px; }
        .main-buttons { display: flex; gap: 10px; margin-bottom: 20px; padding: 14px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); }
        .main-btn { flex: 1; padding: 12px 8px; font-size: 14px; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .main-btn:active { transform: translateY(1px); }
        .calc-btn { background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; }
        .calc-btn:hover { box-shadow: 0 4px 12px rgba(76,175,80,0.3); }
        .settings-btn { background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; }
        .settings-btn:hover { box-shadow: 0 4px 12px rgba(255,152,0,0.3); }
        .work-section { background: linear-gradient(135deg, #e3f2fd 0%, #f1f8ff 100%); padding: 16px; border-radius: 10px; margin-bottom: 18px; border: 1px solid rgba(66,165,245,0.2); }
        .work-section h3 { margin-bottom: 14px; color: #1976d2; font-size: 15px; font-weight: 600; }
        .time-row { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; flex-wrap: wrap; }
        .time-row label { font-weight: 500; color: #555; font-size: 13px; min-width: 45px; }
        .time-row input { flex: 1; min-width: 80px; padding: 8px; border: 2px solid #e1e5e9; border-radius: 6px; font-size: 14px; }
        .break-row { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; flex-wrap: wrap; }
        .break-row label { font-weight: 500; color: #555; font-size: 13px; min-width: 45px; }
        .break-inputs { display: flex; gap: 6px; flex: 1; min-width: 160px; }
        .break-inputs input { flex: 1; min-width: 70px; padding: 8px; border: 2px solid #e1e5e9; border-radius: 6px; font-size: 14px; }
        .holiday-btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white; }
        .holiday-btn.active { background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); }
        .work-summary { margin-top: 10px; padding: 8px; background: rgba(255,255,255,0.6); border-radius: 6px; font-size: 13px; color: #555; }
        .expense-section { background: linear-gradient(135deg, #fff8e1 0%, #fffbf0 100%); padding: 16px; border-radius: 10px; border: 1px solid rgba(255,193,7,0.2); }
        .expense-section h3 { margin-bottom: 14px; color: #f57c00; font-size: 15px; font-weight: 600; }
        .expense-input-row { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
        .expense-input-row input { flex: 1; min-width: 120px; padding: 10px; border: 2px solid #e1e5e9; border-radius: 6px; font-size: 15px; }
        .expense-button-row { display: flex; gap: 8px; margin-bottom: 14px; flex-wrap: wrap; align-items: center; }
        .action-btn { flex: 1; min-width: 80px; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s ease; text-align: center; }
        .essential-btn { background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%); color: white; box-shadow: 0 2px 6px rgba(229,62,62,0.2); }
        .need-btn { background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; box-shadow: 0 2px 6px rgba(76,175,80,0.2); }
        .want-btn { background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white; box-shadow: 0 2px 6px rgba(33,150,243,0.2); }
        .loss-btn { background: #9e9e9e; color: white; flex: 0 0 50px; font-size: 16px; padding: 10px 8px; }
        .expense-edit-row { display: none; gap: 8px; margin-bottom: 14px; flex-wrap: wrap; }
        .edit-btn { flex: 1; min-width: 80px; padding: 8px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s ease; }
        .update-btn { background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; }
        .delete-btn { background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white; }
        .cancel-btn { background: linear-gradient(135deg, #9e9e9e 0%, #757575 100%); color: white; }
        .expense-list { background: white; border: 2px solid #f5f5f5; border-radius: 8px; min-height: 160px; padding: 10px; margin: 14px 0; box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); }
        .expense-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 8px; border-bottom: 1px solid #f0f0f0; cursor: pointer; border-radius: 4px; margin-bottom: 3px; transition: all 0.2s ease; position: relative; }
        .expense-item:hover { background: #f8f9fa; transform: translateX(4px); }
        .expense-item.selected { background: linear-gradient(135deg, #e3f2fd 0%, #f1f8ff 100%); border-color: #42a5f5; box-shadow: 0 2px 8px rgba(66,165,245,0.2); }
        .expense-item.essential { border-left: 4px solid #e53e3e; }
        .expense-item.need { border-left: 4px solid #4caf50; }
        .expense-item.want { border-left: 4px solid #2196f3; }
        .expense-item.loss { border-left: 4px solid #9e9e9e; }
        .expense-category.essential { background: #e53e3e; }
        .expense-category.need { background: #4caf50; }
        .expense-category.want { background: #2196f3; }
        .expense-category.loss { background: #9e9e9e; }
        .expense-category { position: absolute; right: 8px; top: 8px; font-size: 10px; padding: 2px 6px; border-radius: 10px; color: white; }
        .expense-amount { font-weight: 600; color: #d32f2f; }
        .expense-time { font-size: 11px; color: #666; }
        .total { font-weight: 700; font-size: 16px; text-align: center; margin-top: 14px; padding: 10px; background: linear-gradient(135deg, #ffebee 0%, #fce4ec 100%); color: #c62828; border-radius: 6px; border: 1px solid rgba(229,57,53,0.2); }
        input:focus, select:focus { outline: none; border-color: #4a90e2; box-shadow: 0 0 0 3px rgba(74,144,226,0.1); }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); padding: 20px; }
        .popup { background: white; padding: 20px; border-radius: 14px; width: 100%; max-width: 380px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: popupSlide 0.3s ease-out; }
        @keyframes popupSlide { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .popup h3 { margin-bottom: 16px; text-align: center; color: #333; font-size: 18px; }
        .popup input, .popup button { margin: 6px 0; width: 100%; }
        .popup button { padding: 10px; background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s ease; }
        .popup button:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(74,144,226,0.3); }
        .close-btn { position: absolute; top: 12px; right: 12px; background: #f44336; padding: 6px 10px; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 12px; }
        .popup label { display: block; margin: 10px 0 4px; font-weight: 500; color: #555; font-size: 14px; }
        .hidden { display: none !important; }
        .loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; color: white; }
        .loading-spinner { border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid white; border-radius: 50%; width: 36px; height: 36px; animation: spin 1s linear infinite; margin-bottom: 14px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        /* Calendar Styles */
        .calendar-container { background: white; border-radius: 10px; padding: 15px; margin: 10px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .calendar-nav { background: #4a90e2; color: white; border: none; border-radius: 5px; padding: 5px 10px; cursor: pointer; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-day { padding: 8px 4px; text-align: center; border-radius: 4px; cursor: pointer; font-size: 12px; min-height: 32px; display: flex; align-items: center; justify-content: center; }
        .calendar-day:hover { background: #e3f2fd; }
        .calendar-day.today { background: #4a90e2; color: white; font-weight: bold; }
        .calendar-day.selected { background: #4caf50; color: white; }
        .calendar-day.holiday { background: #ffeb3b; color: #333; }
        .calendar-day.disabled { color: #ccc; cursor: not-allowed; }
        .calendar-weekday { font-weight: bold; color: #666; text-align: center; padding: 5px; }
        
        /* Slider Styles */
        .slider-container { margin: 10px 0; }
        .slider { width: 100%; height: 6px; border-radius: 3px; background: #ddd; outline: none; -webkit-appearance: none; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #4a90e2; cursor: pointer; }
        .slider::-moz-range-thumb { width: 20px; height: 20px; border-radius: 50%; background: #4a90e2; cursor: pointer; border: none; }
        
        .editing-mode { border: 2px solid #4a90e2; background: #f0f8ff; }
        
        /* Goal Styles */
        .goal-section { border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin: 15px 0; background: #fafafa; }
        .goal-section h4 { color: #333; margin-bottom: 10px; font-size: 16px; }
        .tolerance-input { display: flex; gap: 10px; align-items: center; margin-top: 8px; }
        .tolerance-input input { flex: 1; }
        .tolerance-input span { font-size: 14px; color: #666; }
        
        /* Chart Styles */
        .charts-container { margin-top: 20px; }
        .chart-item { background: white; border-radius: 10px; padding: 15px; margin: 10px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .chart-item h4 { color: #333; margin-bottom: 10px; font-size: 14px; text-align: center; }
        .chart-canvas { width: 100%; height: 200px; }
        
        /* Status Colors */
        .status-excellent { color: #4caf50; font-weight: bold; }
        .status-good { color: #8bc34a; font-weight: bold; }
        .status-okay { color: #ff9800; font-weight: bold; }
        .status-bad { color: #f44336; font-weight: bold; }
        
        @media (max-width: 480px) { 
            body { padding: 4px; padding-top: 70px; } 
            .container { border-radius: 12px; max-width: 100%; } 
            .top-bar { padding: 8px 12px; font-size: 12px; } 
            .content { padding: 12px; } 
            .user-name { max-width: 60px; } 
            input, select { font-size: 16px; } 
            .popup { padding: 15px; } 
            .btn { font-size: 11px; padding: 4px 8px; }
            .left-controls { gap: 4px; }
        }
    </style>
</head>
<body>
    <!-- Loading -->
    <div class="loading" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div>Sistem ba≈ülatƒ±lƒ±yor...</div>
    </div>
    
    <!-- Main Container -->
    <div class="container hidden" id="mainContainer">
        <div class="top-bar">
            <div class="left-controls">
                <button class="btn" id="dateBtn" onclick="toggleCalendar()">üìÖ Takvim</button>
                <button class="btn" onclick="goToToday()">Bug√ºn</button>
                <button class="btn" onclick="logout()">√áƒ±kƒ±≈ü</button>
            </div>
            <div class="user-section">
                <span>üë§</span>
                <span class="user-name" id="userName">Kullanƒ±cƒ±</span>
            </div>
        </div>
        
        <div class="content">
            <!-- Ana Butonlar -->
            <div class="main-buttons">
                <button class="main-btn calc-btn" onclick="openCalculation()">Hesapla üìà</button>
                <button class="main-btn settings-btn" onclick="openSettings()">‚öôÔ∏è</button>
            </div>
            
            <!-- Calendar -->
            <div class="calendar-container" id="calendarContainer" style="display: none;">
                <div class="calendar-header">
                    <button class="calendar-nav" onclick="changeMonth(-1)">‚Äπ</button>
                    <h4 id="calendarTitle">Aralƒ±k 2024</h4>
                    <button class="calendar-nav" onclick="changeMonth(1)">‚Ä∫</button>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
            </div>
            
            <!-- G√ºnl√ºk ƒ∞√ßerik -->
            <div id="dayContent">
                <!-- √áalƒ±≈üma Bilgileri -->
                <div class="work-section">
                    <h3>üìã √áalƒ±≈üma Bilgileri</h3>
                    <div class="time-row">
                        <label>Giri≈ü:</label>
                        <input type="text" id="startTime" placeholder="14:30" pattern="[0-9]{2}:[0-9]{2}" maxlength="5" onchange="saveWorkData()" onkeyup="formatTimeInput(this)">
                        <label>√áƒ±kƒ±≈ü:</label>
                        <input type="text" id="endTime" placeholder="18:00" pattern="[0-9]{2}:[0-9]{2}" maxlength="5" onchange="saveWorkData()" onkeyup="formatTimeInput(this)">
                    </div>
                    <div class="break-row">
                        <label>Mola:</label>
                        <input type="text" id="breakTime" placeholder="01:00" pattern="[0-9]{2}:[0-9]{2}" maxlength="5" onchange="saveWorkData()" onkeyup="formatTimeInput(this)">
                        <button class="holiday-btn" id="holidayBtn" onclick="toggleHoliday()">ƒ∞zinli</button>
                    </div>
                    <div class="work-summary" id="workSummary"></div>
                </div>
                
                <!-- Harcamalar -->
                <div class="expense-section">
                    <h3>üí∞ G√ºnl√ºk Harcamalar</h3>
                    <div class="expense-input-row">
                        <input type="number" id="expenseAmount" placeholder="Fiyat" min="0" step="0.01">
                        <input type="text" id="expenseName" placeholder="A√ßƒ±klama">
                    </div>
                    <div class="expense-button-row">
                        <button class="action-btn essential-btn" onclick="addExpense('essential')">ZARURI</button>
                        <button class="action-btn need-btn" onclick="addExpense('need')">ƒ∞HTIYA√á</button>
                        <button class="action-btn want-btn" onclick="addExpense('want')">ƒ∞STEK</button>
                        <button class="action-btn loss-btn" onclick="addExpense('loss')">üóëÔ∏è</button>
                    </div>
                    
                    <div class="expense-edit-row" id="editButtonRow">
                        <button class="edit-btn update-btn" onclick="updateExpense()">G√úNCELLE</button>
                        <button class="edit-btn delete-btn" onclick="deleteSelected()">Sƒ∞L</button>
                        <button class="edit-btn cancel-btn" onclick="cancelEdit()">ƒ∞PTAL</button>
                    </div>
                    
                    <div class="expense-list" id="expenseList">
                        <div style="text-align: center; color: #666; padding: 30px;">Hen√ºz harcama eklenmemi≈ü</div>
                    </div>
                    
                    <div class="total" id="dailyTotal">G√ºnl√ºk Toplam: 0 TL</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Login Popup -->
    <div class="overlay" id="loginOverlay">
        <div class="popup">
            <h3>üîê Giri≈ü Yapƒ±n</h3>
            <input type="email" id="emailInput" placeholder="E-posta" value="@.">
            <input type="password" id="passwordInput" placeholder="≈ûifre">
            <button onclick="login()">Giri≈ü Yap</button>
            <div id="errorMessage" style="color: red; margin-top: 10px; display: none;"></div>
        </div>
    </div>
    
    <!-- Settings Popup -->
    <div class="overlay" id="settingsOverlay">
        <div class="popup">
            <button class="close-btn" onclick="closeSettings()">‚úï</button>
            <h3>‚öôÔ∏è Ayarlar</h3>
            <label>Aylƒ±k Kazan√ß (TL):</label>
            <input type="number" id="monthlyIncome" min="0">
            <label>Haftalƒ±k √áalƒ±≈üma Saati:</label>
            <input type="number" id="weeklyHours" min="0" max="168">
            <label>Haftada Ka√ß G√ºn √áalƒ±≈üƒ±yorsun:</label>
            <input type="number" id="workDaysPerWeek" min="1" max="7" value="5">
            <label>G√ºnl√ºk Max √áalƒ±≈üma S√ºresi (saat):</label>
            <input type="number" id="maxDailyHours" min="0" max="24" value="8">
            
            <label>Mali Durum:</label>
            <div class="slider-container">
                <input type="range" min="1" max="5" value="3" class="slider" id="financialStatus">
                <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666;">
                    <span>√áok Sƒ±kƒ±≈üƒ±k</span>
                    <span>Normal</span>
                    <span>√áok Rahat</span>
                </div>
            </div>
            
            <button onclick="saveSettings()">Kaydet</button>
            <button onclick="openGoals()" style="background: linear-gradient(135deg, #9c27b0 0%, #673ab7 100%); margin-top: 10px;">üéØ Hedef Belirle</button>
        </div>
    </div>
    
    <!-- Goals Popup -->
    <div class="overlay" id="goalsOverlay">
        <div class="popup" style="max-height: 90vh; overflow-y: auto;">
            <button class="close-btn" onclick="closeGoals()">‚úï</button>
            <h3>üéØ Hedefler ve Toleranslar</h3>
            
            <div class="goal-section">
                <h4>üìÖ G√ºnl√ºk Harcama Hedefi</h4>
                <input type="number" id="dailyGoal" min="0" placeholder="√ñrn: 100">
                <div class="tolerance-input">
                    <span>Tolerans:</span>
                    <input type="number" id="dailyTolerance" min="0" placeholder="√ñrn: 20">
                    <span>TL</span>
                </div>
                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                    ‚Ä¢ Hedef altƒ±: M√ºkemmel<br>
                    ‚Ä¢ Hedef + tolerans arasƒ±: Makul<br>
                    ‚Ä¢ Tolerans √ºst√º: Limit a≈üƒ±mƒ±
                </div>
            </div>
            
            <div class="goal-section">
                <h4>üìä Haftalƒ±k Harcama Hedefi</h4>
                <input type="number" id="weeklyGoal" min="0" placeholder="√ñrn: 700">
                <div class="tolerance-input">
                    <span>Tolerans:</span>
                    <input type="number" id="weeklyTolerance" min="0" placeholder="√ñrn: 100">
                    <span>TL</span>
                </div>
            </div>
            
            <div class="goal-section">
                <h4>üìà Aylƒ±k Harcama Hedefi</h4>
                <input type="number" id="monthlyGoal" min="0" placeholder="√ñrn: 3000">
                <div class="tolerance-input">
                    <span>Tolerans:</span>
                    <input type="number" id="monthlyTolerance" min="0" placeholder="√ñrn: 500">
                    <span>TL</span>
                </div>
            </div>
            
            <div class="goal-section">
                <h4>üí∞ Birikim Hedefi</h4>
                <input type="number" id="savingsGoal" min="0" placeholder="√ñrn: 5000">
                <label style="margin-top: 10px;">Hedef Tarihi:</label>
                <input type="date" id="savingsDeadline">
            </div>
            
            <button onclick="saveGoals()">Hedefleri Kaydet</button>
        </div>
    </div>
    
    <!-- Calculation Popup -->
    <div class="overlay" id="calculationOverlay">
        <div class="popup" style="max-width: 500px; max-height: 90vh; overflow-y: auto;">
            <button class="close-btn" onclick="closeCalculation()">‚úï</button>
            <h3>üìà Detaylƒ± Finansal Analiz</h3>
            <div id="calculationResults">
                <p>Hesaplama yapƒ±lƒ±yor...</p>
            </div>
            
            <!-- Charts Container -->
            <div class="charts-container" id="chartsContainer">
                <div class="chart-item">
                    <h4>üìä Son 7 G√ºn√ºn Harcama Trendi</h4>
                    <canvas id="dailyChart" class="chart-canvas"></canvas>
                </div>
                
                <div class="chart-item">
                    <h4>üìà Aylƒ±k K√ºm√ºlatif Harcama</h4>
                    <canvas id="cumulativeChart" class="chart-canvas"></canvas>
                </div>
                
                <div class="chart-item">
                    <h4>üéØ G√ºnl√ºk Hedef Durumu</h4>
                    <canvas id="goalChart" class="chart-canvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAIGzwmEB9F7K7KQzsEU5etVWejZ3oSluc",
            authDomain: "paralayici.firebaseapp.com",
            projectId: "paralayici",
            storageBucket: "paralayici.firebasestorage.app",
            messagingSenderId: "980843550614",
            appId: "1:980843550614:web:93dd5bda4ddc377b20efb7"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        let currentUser = null;
        let selectedDate = null;
        let selectedExpenseIndex = -1;
        let editingExpenseIndex = -1;
        let currentDayData = { expenses: [], workData: {}, isHoliday: false };
        let calendarCurrentMonth = new Date();
        let editingCategory = null; // D√ºzenleme sƒ±rasƒ±nda se√ßilen kategori
        
        // Ba≈ülangƒ±√ß
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => checkAutoLogin(), 1000);
        });
        
        // Otomatik Giri≈ü Kontrol√º
        async function checkAutoLogin() {
            const savedLogin = localStorage.getItem('finans_login');
            if (savedLogin) {
                try {
                    const loginData = JSON.parse(savedLogin);
                    const userDoc = await db.collection('users').doc(loginData.userId).get();
                    if (userDoc.exists()) {
                        currentUser = { uid: loginData.userId, ...userDoc.data() };
                        showMainApp();
                        return;
                    }
                } catch (error) {
                    localStorage.removeItem('finans_login');
                }
            }
            showLoginPopup();
        }
        
        // Login ƒ∞≈ülemi
        async function login() {
            const email = document.getElementById('emailInput').value.trim();
            const password = document.getElementById('passwordInput').value.trim();
            
            if (!email || !password) {
                showError('E-posta ve ≈üifre gerekli!');
                return;
            }
            
            try {
                const usersSnapshot = await db.collection('users')
                    .where('email', '==', email)
                    .where('password', '==', password)
                    .get();
                
                if (usersSnapshot.empty) {
                    showError('E-posta veya ≈üifre hatalƒ±!');
                    return;
                }
                
                const userDoc = usersSnapshot.docs[0];
                currentUser = { uid: userDoc.id, ...userDoc.data() };
                
                localStorage.setItem('finans_login', JSON.stringify({
                    userId: userDoc.id,
                    email: email
                }));
                
                showMainApp();
            } catch (error) {
                showError('Baƒülantƒ± hatasƒ±!');
            }
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        function logout() {
            if (confirm('√áƒ±kƒ±≈ü yapmak istediƒüinizden emin misiniz?')) {
                localStorage.removeItem('finans_login');
                currentUser = null;
                showLoginPopup();
            }
        }
        
        function showLoginPopup() {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('loginOverlay').style.display = 'flex';
            document.getElementById('mainContainer').classList.add('hidden');
        }
        
        async function showMainApp() {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainContainer').classList.remove('hidden');
            document.getElementById('userName').textContent = currentUser.username || currentUser.email;
            
            await goToToday();
            renderCalendar();
        }
        
        // Takvim ƒ∞≈ülevleri - Tarih kaymasƒ± d√ºzeltildi
        function toggleCalendar() {
            const calendar = document.getElementById('calendarContainer');
            calendar.style.display = calendar.style.display === 'none' ? 'block' : 'none';
            if (calendar.style.display === 'block') {
                renderCalendar();
            }
        }
        
        function changeMonth(direction) {
            calendarCurrentMonth.setMonth(calendarCurrentMonth.getMonth() + direction);
            renderCalendar();
        }
        
        async function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const title = document.getElementById('calendarTitle');
            
            const months = ['Ocak', '≈ûubat', 'Mart', 'Nisan', 'Mayƒ±s', 'Haziran',
                           'Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k'];
            
            title.textContent = `${months[calendarCurrentMonth.getMonth()]} ${calendarCurrentMonth.getFullYear()}`;
            
            grid.innerHTML = '';
            
            // Haftanƒ±n g√ºnleri
            ['Pt', 'Sa', '√áa', 'Pe', 'Cu', 'Ct', 'Pa'].forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-weekday';
                dayEl.textContent = day;
                grid.appendChild(dayEl);
            });
            
            const firstDay = new Date(calendarCurrentMonth.getFullYear(), calendarCurrentMonth.getMonth(), 1);
            const lastDay = new Date(calendarCurrentMonth.getFullYear(), calendarCurrentMonth.getMonth() + 1, 0);
            const today = new Date();
            
            // Ayƒ±n ba≈üƒ±ndan √∂nceki bo≈ü g√ºnler
            const startingDay = (firstDay.getDay() + 6) % 7; // Pazartesi = 0
            for (let i = 0; i < startingDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day disabled';
                grid.appendChild(emptyDay);
            }
            
            // ƒ∞zinli g√ºnleri y√ºkle
            const holidayDays = await getHolidayDays();
            
            // Ayƒ±n g√ºnleri
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                dayEl.textContent = day;
                
                // Tarih olu≈üturma d√ºzeltildi - yerel saat dilimi kullanƒ±lƒ±yor
                const currentDate = new Date(calendarCurrentMonth.getFullYear(), calendarCurrentMonth.getMonth(), day);
                const dateStr = currentDate.getFullYear() + '-' + 
                    String(currentDate.getMonth() + 1).padStart(2, '0') + '-' + 
                    String(currentDate.getDate()).padStart(2, '0');
                
                // Bug√ºn m√º?
                const todayStr = today.getFullYear() + '-' + 
                    String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                    String(today.getDate()).padStart(2, '0');
                
                if (dateStr === todayStr) {
                    dayEl.classList.add('today');
                }
                
                // Se√ßili g√ºn m√º?
                if (selectedDate === dateStr) {
                    dayEl.classList.add('selected');
                }
                
                // ƒ∞zinli g√ºn m√º?
                if (holidayDays.includes(dateStr)) {
                    dayEl.classList.add('holiday');
                }
                
                dayEl.onclick = () => selectCalendarDate(dateStr);
                grid.appendChild(dayEl);
            }
        }
        
        async function getHolidayDays() {
            if (!currentUser) return [];
            
            try {
                const startOfMonth = new Date(calendarCurrentMonth.getFullYear(), calendarCurrentMonth.getMonth(), 1);
                const endOfMonth = new Date(calendarCurrentMonth.getFullYear(), calendarCurrentMonth.getMonth() + 1, 0);
                
                const startStr = startOfMonth.getFullYear() + '-' + 
                    String(startOfMonth.getMonth() + 1).padStart(2, '0') + '-' + 
                    String(startOfMonth.getDate()).padStart(2, '0');
                const endStr = endOfMonth.getFullYear() + '-' + 
                    String(endOfMonth.getMonth() + 1).padStart(2, '0') + '-' + 
                    String(endOfMonth.getDate()).padStart(2, '0');
                
                const dailyDocs = await db.collection('users').doc(currentUser.uid)
                    .collection('daily')
                    .where('__name__', '>=', startStr)
                    .where('__name__', '<=', endStr)
                    .get();
                
                const holidays = [];
                dailyDocs.forEach(doc => {
                    const data = doc.data();
                    if (data.isHoliday) {
                        holidays.push(doc.id);
                    }
                });
                
                return holidays;
            } catch (error) {
                console.error('ƒ∞zinli g√ºnler y√ºklenemedi:', error);
                return [];
            }
        }
        
        async function selectCalendarDate(dateStr) {
            selectedDate = dateStr;
            const dateObj = new Date(dateStr + 'T12:00:00'); // Noon to avoid timezone issues
            document.getElementById('dateBtn').textContent = 'üìÖ ' + dateObj.toLocaleDateString('tr-TR');
            document.getElementById('calendarContainer').style.display = 'none';
            await forceLoadDayData();
            renderCalendar(); // Se√ßili g√ºn√º g√ºncellemek i√ßin
        }
        
        async function goToToday() {
            const today = new Date();
            const todayStr = today.getFullYear() + '-' + 
                String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                String(today.getDate()).padStart(2, '0');
            
            selectedDate = todayStr;
            calendarCurrentMonth = new Date();
            document.getElementById('dateBtn').textContent = 'üìÖ ' + today.toLocaleDateString('tr-TR');
            await forceLoadDayData();
        }
        
        // Saat input formatƒ± otomatik d√ºzenleme
        function formatTimeInput(input) {
            let value = input.value.replace(/[^\d]/g, '');
            
            if (value.length >= 3) {
                value = value.substring(0, 2) + ':' + value.substring(2, 4);
            }
            
            input.value = value;
            
            if (value.length === 5) {
                const [hours, minutes] = value.split(':');
                if (parseInt(hours) > 23) {
                    input.value = '23:' + minutes;
                }
                if (parseInt(minutes) > 59) {
                    input.value = hours + ':59';
                }
            }
        }
        
        function validateTimeFormat(timeStr) {
            if (!timeStr || timeStr.length !== 5) return false;
            
            const [hours, minutes] = timeStr.split(':');
            const h = parseInt(hours);
            const m = parseInt(minutes);
            
            return h >= 0 && h <= 23 && m >= 0 && m <= 59;
        }
        
        // Zorla veri y√ºkleme
        async function forceLoadDayData() {
            if (!selectedDate || !currentUser || !currentUser.uid) {
                return;
            }
            
            try {
                const dayDoc = await db.collection('users').doc(currentUser.uid)
                    .collection('daily').doc(selectedDate).get({ source: 'server' });
                
                if (dayDoc.exists) {
                    const data = dayDoc.data();
                    currentDayData = {
                        expenses: data.expenses || [],
                        workData: data.workData || {},
                        isHoliday: data.isHoliday || false
                    };
                } else {
                    currentDayData = { expenses: [], workData: {}, isHoliday: false };
                }
                
                selectedExpenseIndex = -1;
                editingExpenseIndex = -1;
                editingCategory = null;
                clearEditingMode();
                updateWorkUI();
                updateExpenseList();
                
            } catch (error) {
                console.error('Veri y√ºkleme hatasƒ±:', error);
                alert('Veriler y√ºklenemedi: ' + error.message);
            }
        }
        
        // √áalƒ±≈üma Verileri
        function updateWorkUI() {
            const workData = currentDayData.workData || {};
            
            document.getElementById('startTime').value = workData.startTime || '';
            document.getElementById('endTime').value = workData.endTime || '';
            
            if (workData.breakTime && workData.breakTime > 0) {
                const hours = Math.floor(workData.breakTime / 60);
                const minutes = workData.breakTime % 60;
                document.getElementById('breakTime').value = 
                    String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0');
            } else {
                document.getElementById('breakTime').value = '';
            }
            
            const holidayBtn = document.getElementById('holidayBtn');
            if (currentDayData.isHoliday) {
                holidayBtn.textContent = '‚úÖ ƒ∞zinli';
                holidayBtn.classList.add('active');
            } else {
                holidayBtn.textContent = 'ƒ∞zinli';
                holidayBtn.classList.remove('active');
            }
            
            updateWorkSummary();
        }
        
        function updateWorkSummary() {
            const workData = currentDayData.workData || {};
            const summaryDiv = document.getElementById('workSummary');
            
            if (currentDayData.isHoliday) {
                summaryDiv.innerHTML = '<p style="color: #4caf50;">üèñÔ∏è Bu g√ºn izinli olarak i≈üaretlenmi≈ü</p>';
                return;
            }
            
            if (workData.startTime && workData.endTime) {
                const start = new Date(`2000-01-01T${workData.startTime}`);
                const end = new Date(`2000-01-01T${workData.endTime}`);
                const breakMinutes = parseInt(workData.breakTime) || 0;
                
                const diffMs = end - start - (breakMinutes * 60000);
                const totalMinutes = Math.floor(diffMs / 60000);
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                
                summaryDiv.innerHTML = `<p>‚è±Ô∏è Toplam: ${hours}s ${minutes}dk (${breakMinutes}dk mola)</p>`;
            } else {
                summaryDiv.innerHTML = '<p style="color: #666;">√áalƒ±≈üma saatleri girilmemi≈ü</p>';
            }
        }
        
        async function saveWorkData() {
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const breakTimeValue = document.getElementById('breakTime').value;
            
            let breakMinutes = 0;
            
            if (breakTimeValue && validateTimeFormat(breakTimeValue)) {
                const [hours, minutes] = breakTimeValue.split(':');
                breakMinutes = (parseInt(hours) * 60) + parseInt(minutes);
            }
            
            const workData = {
                startTime: validateTimeFormat(startTime) ? startTime : '',
                endTime: validateTimeFormat(endTime) ? endTime : '',
                breakTime: breakMinutes
            };
            
            currentDayData.workData = workData;
            updateWorkSummary();
            await saveDayData();
        }
        
        async function toggleHoliday() {
            currentDayData.isHoliday = !currentDayData.isHoliday;
            updateWorkUI();
            await saveDayData();
            renderCalendar(); // Takvimi g√ºncelle
        }
        
        // Harcama ƒ∞≈ülemleri - Geli≈ütirilmi≈ü kategori sistemi
        function addExpense(category) {
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const name = document.getElementById('expenseName').value.trim();
            
            if (!amount || amount <= 0) {
                alert('Ge√ßerli bir fiyat girin!');
                return;
            }
            
            if (editingExpenseIndex >= 0) {
                // D√ºzenleme modundayken kategori deƒüi≈üikliƒüi
                editingCategory = category;
                return;
            }
            
            const now = new Date();
            const expense = {
                amount: amount,
                name: name || 'Harcama',
                time: now.toTimeString().slice(0, 5),
                category: category,
                timestamp: now.toISOString()
            };
            
            currentDayData.expenses.push(expense);
            
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseName').value = '';
            
            updateExpenseList();
            saveDayData();
            
            // Tavsiye sistemi
            setTimeout(() => showExpenseRecommendation(category, amount), 500);
        }
        
        function showExpenseRecommendation(category, amount) {
            let message = '';
            const dayTotal = currentDayData.expenses.reduce((sum, exp) => sum + exp.amount, 0);
            
            if (category === 'want' && amount > 50) {
                message = 'üí° ƒ∞pucu: Bu b√ºy√ºk bir istek harcamasƒ±! Ger√ßekten gerekli miydi?';
            } else if (category === 'essential' && amount > 100) {
                message = 'üìä Not: B√ºy√ºk bir zorunlu harcama. B√ºt√ßenizi kontrol edin.';
            } else if (dayTotal > 200) {
                message = '‚ö†Ô∏è Dikkat: G√ºnl√ºk harcamanƒ±z 200 TL\'yi a≈ütƒ±!';
            } else if (category === 'need') {
                message = '‚úÖ ƒ∞yi tercih: ƒ∞htiya√ß harcamasƒ± yapƒ±yorsunuz.';
            }
            
            if (message) {
                // Ge√ßici bildirim g√∂ster
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed; top: 100px; left: 50%; transform: translateX(-50%);
                    background: #333; color: white; padding: 10px 15px; border-radius: 8px;
                    font-size: 12px; z-index: 1001; max-width: 300px; text-align: center;
                    animation: slideDown 0.3s ease-out;
                `;
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => notification.remove(), 3000);
            }
        }
        
        function selectExpense(index) {
            if (editingExpenseIndex >= 0 && editingExpenseIndex !== index) {
                if (confirm('Deƒüi≈üiklikleri kaydetmek istiyor musunuz?')) {
                    updateExpense();
                } else {
                    cancelEdit();
                }
            }
            
            selectedExpenseIndex = selectedExpenseIndex === index ? -1 : index;
            
            if (selectedExpenseIndex >= 0) {
                enterEditingMode(selectedExpenseIndex);
            } else {
                clearEditingMode();
            }
            
            updateExpenseList();
        }
        
        function enterEditingMode(index) {
            editingExpenseIndex = index;
            const expense = currentDayData.expenses[index];
            editingCategory = expense.category;
            
            // Formu doldur
            document.getElementById('expenseAmount').value = expense.amount;
            document.getElementById('expenseName').value = expense.name;
            
            // Form stilini deƒüi≈ütir
            document.querySelector('.expense-input-row').classList.add('editing-mode');
            
            // Edit buton satƒ±rƒ±nƒ± g√∂ster
            document.getElementById('editButtonRow').style.display = 'flex';
            
            // Kategori butonlarƒ±nƒ± highlight et
            updateCategoryButtons();
        }
        
        function updateCategoryButtons() {
            const buttons = document.querySelectorAll('.expense-button-row .action-btn');
            buttons.forEach(btn => {
                btn.style.opacity = '0.5';
                btn.style.transform = 'scale(0.95)';
            });
            
            if (editingCategory) {
                const activeBtn = document.querySelector(`.${editingCategory}-btn`);
                if (activeBtn) {
                    activeBtn.style.opacity = '1';
                    activeBtn.style.transform = 'scale(1.05)';
                    activeBtn.style.boxShadow = '0 4px 15px rgba(74,144,226,0.4)';
                }
            }
        }
        
        function clearEditingMode() {
            editingExpenseIndex = -1;
            editingCategory = null;
            
            // Formu temizle
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseName').value = '';
            
            // Form stilini sƒ±fƒ±rla
            document.querySelector('.expense-input-row').classList.remove('editing-mode');
            
            // Edit buton satƒ±rƒ±nƒ± gizle
            document.getElementById('editButtonRow').style.display = 'none';
            
            // Kategori butonlarƒ±nƒ± normale d√∂nd√ºr
            const buttons = document.querySelectorAll('.expense-button-row .action-btn');
            buttons.forEach(btn => {
                btn.style.opacity = '1';
                btn.style.transform = 'scale(1)';
                btn.style.boxShadow = '';
            });
        }
        
        function updateExpense() {
            if (editingExpenseIndex < 0) return;
            
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const name = document.getElementById('expenseName').value.trim();
            
            if (!amount || amount <= 0) {
                alert('Ge√ßerli bir fiyat girin!');
                return;
            }
            
            // G√ºncelle
            currentDayData.expenses[editingExpenseIndex].amount = amount;
            currentDayData.expenses[editingExpenseIndex].name = name || 'Harcama';
            
            // Kategori deƒüi≈üikliƒüi varsa uygula
            if (editingCategory) {
                currentDayData.expenses[editingExpenseIndex].category = editingCategory;
            }
            
            clearEditingMode();
            selectedExpenseIndex = -1;
            updateExpenseList();
            saveDayData();
        }
        
        function cancelEdit() {
            clearEditingMode();
            selectedExpenseIndex = -1;
            updateExpenseList();
        }
        
        function updateExpenseList() {
            const listDiv = document.getElementById('expenseList');
            const expenses = currentDayData.expenses || [];
            
            if (expenses.length === 0) {
                listDiv.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">Hen√ºz harcama eklenmemi≈ü</div>';
                document.getElementById('dailyTotal').innerHTML = 'G√ºnl√ºk Toplam: 0 TL';
                return;
            }
            
            let html = '';
            let totalEssential = 0;
            let totalNeed = 0;
            let totalWant = 0;
            let totalLoss = 0;
            
            expenses.forEach((expense, index) => {
                switch(expense.category) {
                    case 'essential': totalEssential += expense.amount; break;
                    case 'need': totalNeed += expense.amount; break;
                    case 'want': totalWant += expense.amount; break;
                    case 'loss': totalLoss += expense.amount; break;
                    default: totalNeed += expense.amount; // Fallback
                }
                
                let timeDisplay = expense.time || '';
                if (expense.timestamp && !expense.time) {
                    timeDisplay = new Date(expense.timestamp).toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'});
                }
                
                const categoryClass = expense.category || 'need';
                const categoryTexts = {
                    essential: 'Zaruri',
                    need: 'ƒ∞htiya√ß', 
                    want: 'ƒ∞stek',
                    loss: 'Kayƒ±p'
                };
                const categoryText = categoryTexts[categoryClass] || 'ƒ∞htiya√ß';
                
                html += `
                    <div class="expense-item ${selectedExpenseIndex === index ? 'selected' : ''} ${categoryClass}" 
                         onclick="selectExpense(${index})">
                        <div>
                            <span class="expense-amount">${expense.amount.toFixed(2)} TL</span>
                            <span> - ${expense.name}</span>
                        </div>
                        <div style="text-align: right;">
                            <div class="expense-category ${categoryClass}">${categoryText}</div>
                            <span class="expense-time">${timeDisplay}</span>
                        </div>
                    </div>
                `;
            });
            
            listDiv.innerHTML = html;
            
            const total = totalEssential + totalNeed + totalWant + totalLoss;
            document.getElementById('dailyTotal').innerHTML = `
                <div>G√ºnl√ºk Toplam: ${total.toFixed(2)} TL</div>
                <div style="font-size: 11px; margin-top: 5px;">
                    Zaruri: ${totalEssential.toFixed(0)}‚Ç∫ | ƒ∞htiya√ß: ${totalNeed.toFixed(0)}‚Ç∫ | ƒ∞stek: ${totalWant.toFixed(0)}‚Ç∫ | Kayƒ±p: ${totalLoss.toFixed(0)}‚Ç∫
                </div>
            `;
        }
        
        function deleteSelected() {
            if (selectedExpenseIndex === -1) {
                alert('Silmek i√ßin √∂nce bir harcama se√ßin!');
                return;
            }
            
            if (confirm('Se√ßili harcamayƒ± silmek istediƒüinizden emin misiniz?')) {
                currentDayData.expenses.splice(selectedExpenseIndex, 1);
                selectedExpenseIndex = -1;
                clearEditingMode();
                updateExpenseList();
                saveDayData();
            }
        }
        
        // Veri Kaydetme
        async function saveDayData() {
            if (!selectedDate) return;
            
            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('daily').doc(selectedDate).set(currentDayData);
            } catch (error) {
                console.error('Veri kaydetme hatasƒ±:', error);
                alert('Veriler kaydedilemedi!');
            }
        }
        
        // Ayarlar
        async function openSettings() {
            document.getElementById('settingsOverlay').style.display = 'flex';
            
            // Alanlarƒ± temizle
            document.getElementById('monthlyIncome').value = '';
            document.getElementById('weeklyHours').value = '';
            document.getElementById('workDaysPerWeek').value = '';
            document.getElementById('maxDailyHours').value = '';
            document.getElementById('financialStatus').value = '3';
            
            try {
                const generalDoc = await db.collection('users').doc(currentUser.uid)
                    .collection('general').doc('settings').get({ source: 'server' });
                
                if (generalDoc.exists) {
                    const settings = generalDoc.data();
                    
                    document.getElementById('monthlyIncome').value = settings.monthlyIncome || '';
                    document.getElementById('weeklyHours').value = settings.weeklyHours || '';
                    document.getElementById('workDaysPerWeek').value = settings.workDaysPerWeek || 5;
                    document.getElementById('maxDailyHours').value = settings.maxDailyHours || 8;
                    document.getElementById('financialStatus').value = settings.financialStatus || 3;
                } else {
                    document.getElementById('workDaysPerWeek').value = 5;
                    document.getElementById('maxDailyHours').value = 8;
                    document.getElementById('financialStatus').value = 3;
                }
            } catch (error) {
                console.error('Ayarlar y√ºkleme hatasƒ±:', error);
            }
        }
        
        function closeSettings() {
            document.getElementById('settingsOverlay').style.display = 'none';
        }
        
        async function saveSettings() {
            const settings = {
                monthlyIncome: parseFloat(document.getElementById('monthlyIncome').value) || 0,
                weeklyHours: parseFloat(document.getElementById('weeklyHours').value) || 0,
                workDaysPerWeek: parseInt(document.getElementById('workDaysPerWeek').value) || 5,
                maxDailyHours: parseFloat(document.getElementById('maxDailyHours').value) || 8,
                financialStatus: parseInt(document.getElementById('financialStatus').value) || 3
            };
            
            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('general').doc('settings').set(settings);
                alert('Ayarlar kaydedildi!');
                closeSettings();
            } catch (error) {
                console.error('Ayar kaydetme hatasƒ±:', error);
                alert('Ayarlar kaydedilemedi!');
            }
        }
        
        // Geli≈ütirilmi≈ü Hedefler
        function openGoals() {
            document.getElementById('goalsOverlay').style.display = 'flex';
            loadGoals();
        }
        
        function closeGoals() {
            document.getElementById('goalsOverlay').style.display = 'none';
        }
        
        async function loadGoals() {
            try {
                const goalsDoc = await db.collection('users').doc(currentUser.uid)
                    .collection('general').doc('goals').get({ source: 'server' });
                
                if (goalsDoc.exists) {
                    const goals = goalsDoc.data();
                    
                    document.getElementById('dailyGoal').value = goals.dailyGoal || '';
                    document.getElementById('dailyTolerance').value = goals.dailyTolerance || '';
                    document.getElementById('weeklyGoal').value = goals.weeklyGoal || '';
                    document.getElementById('weeklyTolerance').value = goals.weeklyTolerance || '';
                    document.getElementById('monthlyGoal').value = goals.monthlyGoal || '';
                    document.getElementById('monthlyTolerance').value = goals.monthlyTolerance || '';
                    document.getElementById('savingsGoal').value = goals.savingsGoal || '';
                    document.getElementById('savingsDeadline').value = goals.savingsDeadline || '';
                }
            } catch (error) {
                console.error('Hedefler y√ºkleme hatasƒ±:', error);
            }
        }
        
        async function saveGoals() {
            const goals = {
                dailyGoal: parseFloat(document.getElementById('dailyGoal').value) || 0,
                dailyTolerance: parseFloat(document.getElementById('dailyTolerance').value) || 0,
                weeklyGoal: parseFloat(document.getElementById('weeklyGoal').value) || 0,
                weeklyTolerance: parseFloat(document.getElementById('weeklyTolerance').value) || 0,
                monthlyGoal: parseFloat(document.getElementById('monthlyGoal').value) || 0,
                monthlyTolerance: parseFloat(document.getElementById('monthlyTolerance').value) || 0,
                savingsGoal: parseFloat(document.getElementById('savingsGoal').value) || 0,
                savingsDeadline: document.getElementById('savingsDeadline').value || ''
            };
            
            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('general').doc('goals').set(goals);
                alert('Hedefler kaydedildi!');
                closeGoals();
            } catch (error) {
                console.error('Hedef kaydetme hatasƒ±:', error);
                alert('Hedefler kaydedilemedi!');
            }
        }
        
        // Hedef durumu hesaplama
        function getGoalStatus(actual, goal, tolerance) {
            if (!goal) return { status: 'none', text: 'Hedef yok', class: '' };
            
            if (actual <= goal) {
                return { status: 'excellent', text: 'M√ºkemmel', class: 'status-excellent' };
            } else if (actual <= goal + tolerance) {
                return { status: 'good', text: 'Makul', class: 'status-good' };
            } else if (actual <= goal + (tolerance * 2)) {
                return { status: 'okay', text: 'Fena deƒüil', class: 'status-okay' };
            } else {
                return { status: 'bad', text: 'Limit a≈üƒ±mƒ±', class: 'status-bad' };
            }
        }
        
        // Geli≈ütirilmi≈ü Hesaplama ve Grafikler
        async function openCalculation() {
            document.getElementById('calculationOverlay').style.display = 'flex';
            document.getElementById('calculationResults').innerHTML = '<p>Hesaplama yapƒ±lƒ±yor...</p>';
            
            try {
                // Ayarlarƒ±, hedefleri ve verileri y√ºkle
                const [settingsDoc, goalsDoc] = await Promise.all([
                    db.collection('users').doc(currentUser.uid).collection('general').doc('settings').get({ source: 'server' }),
                    db.collection('users').doc(currentUser.uid).collection('general').doc('goals').get({ source: 'server' })
                ]);
                
                const settings = settingsDoc.exists ? settingsDoc.data() : {};
                const goals = goalsDoc.exists ? goalsDoc.data() : {};
                
                // Bu ayƒ±n verilerini al
                const currentMonth = new Date().toISOString().slice(0, 7);
                const dailyDocs = await db.collection('users').doc(currentUser.uid)
                    .collection('daily')
                    .where('__name__', '>=', currentMonth)
                    .where('__name__', '<', currentMonth + '-32')
                    .get({ source: 'server' });
                
                // Veri analizi
                const analysisData = analyzeExpenseData(dailyDocs, settings, goals);
                
                // Hesaplama sonu√ßlarƒ±nƒ± g√∂ster
                displayCalculationResults(analysisData, settings, goals);
                
                // Grafikleri √ßiz
                await drawCharts(analysisData, goals);
                
            } catch (error) {
                console.error('Hesaplama hatasƒ±:', error);
                document.getElementById('calculationResults').innerHTML = '<p style="color: red;">Hesaplama hatasƒ±: ' + error.message + '</p>';
            }
        }
        
        function analyzeExpenseData(dailyDocs, settings, goals) {
            let monthlyExpenses = { essential: 0, need: 0, want: 0, loss: 0, total: 0 };
            let dailyExpenses = { essential: 0, need: 0, want: 0, loss: 0, total: 0 };
            let totalWorkMinutes = 0;
            let workDays = 0;
            let dailyData = [];
            let cumulativeData = [];
            let cumulativeSum = 0;
            
            const todayStr = new Date().toISOString().split('T')[0];
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 6);
            
            dailyDocs.forEach(doc => {
                const data = doc.data();
                const expenses = data.expenses || [];
                const date = doc.id;
                
                let dayExpenses = { essential: 0, need: 0, want: 0, loss: 0, total: 0 };
                
                expenses.forEach(exp => {
                    const category = exp.category || 'need';
                    const amount = exp.amount || 0;
                    
                    dayExpenses[category] += amount;
                    dayExpenses.total += amount;
                    monthlyExpenses[category] += amount;
                    monthlyExpenses.total += amount;
                });
                
                // Bug√ºnk√º harcamalar
                if (date === todayStr) {
                    dailyExpenses = dayExpenses;
                }
                
                // Son 7 g√ºn i√ßin daily chart data
                if (date >= weekAgo.toISOString().split('T')[0]) {
                    dailyData.push({
                        date: date,
                        amount: dayExpenses.total,
                        essential: dayExpenses.essential,
                        need: dayExpenses.need,
                        want: dayExpenses.want,
                        loss: dayExpenses.loss
                    });
                }
                
                // K√ºm√ºlatif veri
                cumulativeSum += dayExpenses.total;
                cumulativeData.push({
                    date: date,
                    cumulative: cumulativeSum
                });
                
                // √áalƒ±≈üma s√ºreleri
                const workData = data.workData || {};
                if (workData.startTime && workData.endTime && !data.isHoliday) {
                    const start = new Date(`2000-01-01T${workData.startTime}`);
                    const end = new Date(`2000-01-01T${workData.endTime}`);
                    const breakMinutes = parseInt(workData.breakTime) || 0;
                    
                    const workMinutes = (end - start) / 60000 - breakMinutes;
                    if (workMinutes > 0) {
                        totalWorkMinutes += workMinutes;
                        workDays++;
                    }
                }
            });
            
            // Sƒ±rala
            dailyData.sort((a, b) => new Date(a.date) - new Date(b.date));
            cumulativeData.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            return {
                monthly: monthlyExpenses,
                daily: dailyExpenses,
                totalWorkMinutes,
                workDays,
                dailyChartData: dailyData,
                cumulativeChartData: cumulativeData
            };
        }
        
        function displayCalculationResults(analysis, settings, goals) {
            const monthlyIncome = settings.monthlyIncome || 0;
            const dailyIncome = monthlyIncome / 30;
            const maxDailyHours = settings.maxDailyHours || 8;
            const financialStatus = settings.financialStatus || 3;
            
            // √áalƒ±≈üma analizi
            const totalWorkHours = analysis.totalWorkMinutes / 60;
            const avgDailyWorkHours = analysis.workDays > 0 ? totalWorkHours / analysis.workDays : 0;
            const hourlyEarning = avgDailyWorkHours > 0 ? dailyIncome / avgDailyWorkHours : 0;
            
            // Bug√ºn√ºn √ßalƒ±≈üma verisi
            const todayWorkData = currentDayData.workData || {};
            let todayWorkHours = 0;
            let overtimeHours = 0;
            
            if (todayWorkData.startTime && todayWorkData.endTime && !currentDayData.isHoliday) {
                const start = new Date(`2000-01-01T${todayWorkData.startTime}`);
                const end = new Date(`2000-01-01T${todayWorkData.endTime}`);
                const breakMinutes = parseInt(todayWorkData.breakTime) || 0;
                
                const todayWorkMinutes = (end - start) / 60000 - breakMinutes;
                todayWorkHours = todayWorkMinutes / 60;
                const maxMinutes = maxDailyHours * 60;
                
                if (todayWorkMinutes > maxMinutes) {
                    overtimeHours = (todayWorkMinutes - maxMinutes) / 60;
                }
            }
            
            // Hedef durumlarƒ±
            const dailyGoalStatus = getGoalStatus(analysis.daily.total, goals.dailyGoal, goals.dailyTolerance);
            const monthlyGoalStatus = getGoalStatus(analysis.monthly.total, goals.monthlyGoal, goals.monthlyTolerance);
            
            // Mali durum
            const statusTexts = ['', '√ßok sƒ±kƒ±≈üƒ±k', 'sƒ±kƒ±≈üƒ±k', 'normal', 'rahat', '√ßok rahat'];
            const statusText = statusTexts[financialStatus] || 'normal';
            
            // Akƒ±llƒ± √∂neriler
            const recommendations = generateSmartRecommendations(analysis, settings, goals);
            
            // Verimlilik metrikleri
            const productivityMetrics = calculateProductivityMetrics(analysis, settings, monthlyIncome);
            
            document.getElementById('calculationResults').innerHTML = `
                <div style="text-align: left; font-size: 13px; line-height: 1.4;">
                    <h4>üíº √áalƒ±≈üma & Kazan√ß Analizi</h4>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin: 8px 0;">
                        ${todayWorkHours > 0 ? `
                            <p><strong>Bug√ºn:</strong> ${todayWorkHours.toFixed(1)} saat √ßalƒ±≈üƒ±ldƒ±</p>
                            ${overtimeHours > 0 ? `<p style="color: #ff9800;"><strong>Mesai:</strong> +${overtimeHours.toFixed(1)} saat ‚è∞</p>` : ''}
                            <p><strong>Saatlik kazan√ß:</strong> ${hourlyEarning.toFixed(2)} TL/saat</p>
                            <p><strong>Bug√ºnk√º i≈ü deƒüeri:</strong> ${(todayWorkHours * hourlyEarning).toFixed(2)} TL</p>
                        ` : '<p style="color: #666;">Bug√ºn √ßalƒ±≈üma verisi girilmemi≈ü</p>'}
                        
                        <p><strong>Ortalama g√ºnl√ºk √ßalƒ±≈üma:</strong> ${avgDailyWorkHours.toFixed(1)} saat</p>
                        <p><strong>Bu ay toplam:</strong> ${totalWorkHours.toFixed(1)} saat (${analysis.workDays} g√ºn)</p>
                    </div>
                    
                    <h4>üí∞ Harcama Daƒüƒ±lƒ±mƒ±</h4>
                    <div style="background: #fff3e0; padding: 10px; border-radius: 6px; margin: 8px 0;">
                        <p><strong>Bug√ºn:</strong> ${analysis.daily.total.toFixed(2)} TL 
                        ${dailyGoalStatus.status !== 'none' ? `<span class="${dailyGoalStatus.class}"> (${dailyGoalStatus.text})</span>` : ''}</p>
                        <div style="font-size: 11px; margin-left: 10px;">
                            ‚Ä¢ Zaruri: ${analysis.daily.essential.toFixed(0)} TL<br>
                            ‚Ä¢ ƒ∞htiya√ß: ${analysis.daily.need.toFixed(0)} TL<br>
                            ‚Ä¢ ƒ∞stek: ${analysis.daily.want.toFixed(0)} TL<br>
                            ‚Ä¢ Kayƒ±p: ${analysis.daily.loss.toFixed(0)} TL
                        </div>
                        
                        <p style="margin-top: 8px;"><strong>Bu ay:</strong> ${analysis.monthly.total.toFixed(2)} TL 
                        ${monthlyGoalStatus.status !== 'none' ? `<span class="${monthlyGoalStatus.class}"> (${monthlyGoalStatus.text})</span>` : ''}</p>
                        <p><strong>Aylƒ±k gelirin:</strong> %${monthlyIncome > 0 ? (analysis.monthly.total / monthlyIncome * 100).toFixed(1) : 0}\'i harcanmƒ±≈ü</p>
                    </div>
                    
                    ${productivityMetrics.length > 0 ? `
                        <h4>üìä Verimlilik Metrikleri</h4>
                        <div style="background: #e3f2fd; padding: 10px; border-radius: 6px; margin: 8px 0;">
                            ${productivityMetrics.map(metric => `<p>‚Ä¢ ${metric}</p>`).join('')}
                        </div>
                    ` : ''}
                    
                    <h4>üéØ Akƒ±llƒ± √ñneriler</h4>
                    <div style="background: #f3e5f5; padding: 10px; border-radius: 6px; margin: 8px 0;">
                        ${recommendations.map(rec => `<p>‚Ä¢ ${rec}</p>`).join('')}
                    </div>
                    
                    <h4>üìà Trend Analizi</h4>
                    <div style="background: #e8f5e8; padding: 10px; border-radius: 6px; margin: 8px 0;">
                        <p><strong>Mali durumun:</strong> ${statusText} seviyesinde</p>
                        ${analysis.daily.want > analysis.daily.need + analysis.daily.essential ? 
                            '<p style="color: #f44336;">‚ö†Ô∏è ƒ∞stek harcamalarƒ±n √ßok y√ºksek!</p>' : 
                            '<p style="color: #4caf50;">‚úÖ √ñnceliklendirme dengeli g√∂r√ºn√ºyor.</p>'}
                        <p><strong>Harcama verimliliƒüi:</strong> ${calculateEfficiencyScore(analysis)}%</p>
                    </div>
                </div>
            `;
        }
        
        function generateSmartRecommendations(analysis, settings, goals) {
            const recommendations = [];
            const financialStatus = settings.financialStatus || 3;
            const monthlyIncome = settings.monthlyIncome || 0;
            
            // Harcama pattern analizi
            const wantRatio = analysis.monthly.total > 0 ? (analysis.monthly.want / analysis.monthly.total) : 0;
            const essentialRatio = analysis.monthly.total > 0 ? (analysis.monthly.essential / analysis.monthly.total) : 0;
            
            if (wantRatio > 0.4) {
                recommendations.push('ƒ∞stek harcamalarƒ±nƒ±z %40\'ƒ± a≈üƒ±yor. Biraz daha dikkatli olun.');
            }
            
            if (essentialRatio > 0.6) {
                recommendations.push('Zorunlu harcamalarƒ±nƒ±z y√ºksek. Alternatif √ß√∂z√ºmler ara≈ütƒ±rƒ±n.');
            }
            
            if (analysis.daily.total > 0 && goals.dailyGoal > 0) {
                if (analysis.daily.total < goals.dailyGoal * 0.8) {
                    recommendations.push('Bug√ºn hedefin altƒ±ndasƒ±n! Biriktirme fƒ±rsatƒ±.');
                } else if (analysis.daily.total > goals.dailyGoal + goals.dailyTolerance) {
                    recommendations.push('G√ºnl√ºk limitini a≈ütƒ±n. Yarƒ±n daha dikkatli ol.');
                }
            }
            
            if (financialStatus <= 2 && wantRatio > 0.2) {
                recommendations.push('Sƒ±kƒ±≈üƒ±k d√∂nemde istek harcamalarƒ±nƒ± minimize et.');
            }
            
            if (monthlyIncome > 0 && analysis.monthly.total / monthlyIncome > 0.8) {
                recommendations.push('Aylƒ±k gelirinin %80\'ini harcamƒ±≈üsƒ±n. Acil fren √ßek!');
            }
            
            // √áalƒ±≈üma √∂nerileri
            if (analysis.workDays > 0) {
                const avgDaily = analysis.totalWorkMinutes / 60 / analysis.workDays;
                if (avgDaily < 6) {
                    recommendations.push('√áalƒ±≈üma saatlerin d√º≈ü√ºk. Ek gelir kaynaklarƒ± d√º≈ü√ºn.');
                } else if (avgDaily > 10) {
                    recommendations.push('√áok √ßalƒ±≈üƒ±yorsun! ƒ∞≈ü-ya≈üam dengeni kontrol et.');
                }
            }
            
            if (recommendations.length === 0) {
                recommendations.push('Finansal durumun dengeli g√∂r√ºn√ºyor. Bu tempoyu koru!');
            }
            
            return recommendations;
        }
        
        function calculateProductivityMetrics(analysis, settings, monthlyIncome) {
            const metrics = [];
            
            if (analysis.totalWorkMinutes > 0 && monthlyIncome > 0) {
                const hourlyValue = (monthlyIncome / 30) / (analysis.totalWorkMinutes / 60 / analysis.workDays);
                metrics.push(`Saatlik deƒüerin: ${hourlyValue.toFixed(2)} TL`);
                
                const workEfficiency = (analysis.totalWorkMinutes / 60) / (analysis.workDays * (settings.maxDailyHours || 8));
                metrics.push(`√áalƒ±≈üma verimliliƒüi: %${(workEfficiency * 100).toFixed(1)}`);
            }
            
            if (analysis.monthly.total > 0) {
                const needRatio = analysis.monthly.need / analysis.monthly.total;
                metrics.push(`ƒ∞htiya√ß odaklƒ±lƒ±k: %${(needRatio * 100).toFixed(1)}`);
                
                const spendingSpeed = analysis.monthly.total / new Date().getDate();
                metrics.push(`G√ºnl√ºk ortalama harcama: ${spendingSpeed.toFixed(2)} TL`);
            }
            
            return metrics;
        }
        
        function calculateEfficiencyScore(analysis) {
            let score = 100;
            
            // ƒ∞stek harcamasƒ± penaltƒ±sƒ±
            const wantRatio = analysis.monthly.total > 0 ? (analysis.monthly.want / analysis.monthly.total) : 0;
            score -= (wantRatio * 30);
            
            // Kayƒ±p penaltƒ±sƒ±
            const lossRatio = analysis.monthly.total > 0 ? (analysis.monthly.loss / analysis.monthly.total) : 0;
            score -= (lossRatio * 50);
            
            // Zaruri harcama fazlalƒ±ƒüƒ± penaltƒ±sƒ±
            const essentialRatio = analysis.monthly.total > 0 ? (analysis.monthly.essential / analysis.monthly.total) : 0;
            if (essentialRatio > 0.5) {
                score -= ((essentialRatio - 0.5) * 40);
            }
            
            return Math.max(0, Math.round(score));
        }
        
        async function drawCharts(analysisData, goals) {
            // Grafik verilerini hazƒ±rla
            const dailyData = analysisData.dailyChartData.slice(-7); // Son 7 g√ºn
            const cumulativeData = analysisData.cumulativeChartData;
            
            // 1. G√ºnl√ºk Harcama Trendi
            const dailyChart = new Chart(document.getElementById('dailyChart'), {
                type: 'line',
                data: {
                    labels: dailyData.map(d => new Date(d.date).toLocaleDateString('tr-TR', {day: '2-digit', month: '2-digit'})),
                    datasets: [
                        {
                            label: 'Toplam',
                            data: dailyData.map(d => d.amount),
                            borderColor: '#4a90e2',
                            backgroundColor: 'rgba(74, 144, 226, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'ƒ∞stek',
                            data: dailyData.map(d => d.want),
                            borderColor: '#e53e3e',
                            backgroundColor: 'rgba(229, 62, 62, 0.1)',
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
            
            // 2. K√ºm√ºlatif Harcama
            const cumulativeChart = new Chart(document.getElementById('cumulativeChart'), {
                type: 'line',
                data: {
                    labels: cumulativeData.map(d => new Date(d.date).toLocaleDateString('tr-TR', {day: '2-digit'})),
                    datasets: [{
                        label: 'K√ºm√ºlatif Harcama',
                        data: cumulativeData.map(d => d.cumulative),
                        borderColor: '#4caf50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
            
            // 3. Hedef Durumu
            if (goals.dailyGoal > 0) {
                const goalChart = new Chart(document.getElementById('goalChart'), {
                    type: 'bar',
                    data: {
                        labels: dailyData.map(d => new Date(d.date).toLocaleDateString('tr-TR', {day: '2-digit'})),
                        datasets: [
                            {
                                label: 'G√ºnl√ºk Harcama',
                                data: dailyData.map(d => d.amount),
                                backgroundColor: dailyData.map(d => {
                                    if (d.amount <= goals.dailyGoal) return 'rgba(76, 175, 80, 0.8)';
                                    if (d.amount <= goals.dailyGoal + goals.dailyTolerance) return 'rgba(255, 152, 0, 0.8)';
                                    return 'rgba(244, 67, 54, 0.8)';
                                })
                            },
                            {
                                label: 'Hedef',
                                data: new Array(dailyData.length).fill(goals.dailyGoal),
                                type: 'line',
                                borderColor: '#2196f3',
                                backgroundColor: 'transparent',
                                borderWidth: 2,
                                pointRadius: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true,
                                max: Math.max(goals.dailyGoal + goals.dailyTolerance + 50, Math.max(...dailyData.map(d => d.amount)) + 50)
                            }
                        }
                    }
                });
            } else {
                document.getElementById('goalChart').parentElement.innerHTML = '<p style="text-align: center; color: #666;">G√ºnl√ºk hedef belirlenmemi≈ü</p>';
            }
        }
        
        function closeCalculation() {
            document.getElementById('calculationOverlay').style.display = 'none';
            
            // Chart.js instances temizle
            Chart.getChart('dailyChart')?.destroy();
            Chart.getChart('cumulativeChart')?.destroy();
            Chart.getChart('goalChart')?.destroy();
        }
        
        // Enter tu≈üu desteƒüi
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (document.getElementById('loginOverlay').style.display === 'flex') {
                    login();
                } else if (editingExpenseIndex >= 0) {
                    updateExpense();
                } else if (document.getElementById('expenseAmount') === document.activeElement || 
                          document.getElementById('expenseName') === document.activeElement) {
                    addExpense('need'); // Varsayƒ±lan olarak ihtiya√ß
                }
            }
        });
        
        // ESC tu≈üu i√ßin d√ºzenleme modundan √ßƒ±kƒ±≈ü
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (editingExpenseIndex >= 0) {
                    if (confirm('Deƒüi≈üiklikleri iptal etmek istediƒüinizden emin misiniz?')) {
                        cancelEdit();
                    }
                }
            }
        });
        
        // CSS animasyonu ekle
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideDown {
                from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
                to { opacity: 1; transform: translateX(-50%) translateY(0); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
