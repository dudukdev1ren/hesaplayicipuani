<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KÃ¼mÃ¼latif Veri Takip UygulamasÄ±</title>
    
    <!-- Firebase SDK YÃ¼kleme (Firestore ve Core) -->
    <!-- Firestore iÅŸlemlerini destekleyen 8.x sÃ¼rÃ¼mÃ¼ kullanÄ±lÄ±yor -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    
    <!-- Chart.js YÃ¼kleme (Grafik OluÅŸturmak Ä°Ã§in) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    
    <style>
        /* Modern ve estetik bir tasarÄ±m iÃ§in CSS */
        body { 
            font-family: 'Inter', Arial, sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 20px; 
            background-color: #f4f7f9;
        }
        .container {
            display: flex;
            gap: 40px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .data-section { 
            background-color: white;
            border: 1px solid #ddd; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
            max-width: 400px;
        }
        h1 { color: #2c3e50; margin-bottom: 20px; }
        h3 { color: #34495e; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; margin-top: 0; }
        
        .button-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 10px; 
            margin-top: 15px;
        }
        .button-grid button { 
            padding: 15px; 
            font-size: 16px; 
            cursor: pointer; 
            border: none;
            border-radius: 8px; 
            transition: all 0.2s;
            font-weight: bold;
            background-color: #ecf0f1;
        }
        .button-grid button:hover { 
            background-color: #bdc3c7; 
            transform: translateY(-2px);
        }
        
        /* Kaydet Butonu */
        #save-button {
            margin-top: 20px; 
            padding: 12px 25px; 
            background-color: #2ecc71; 
            color: white; 
            border: none; 
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-size: 17px;
            transition: background-color 0.2s;
            box-shadow: 0 4px #27ae60;
        }
        #save-button:active {
            box-shadow: 0 1px #27ae60;
            transform: translateY(3px);
        }

        /* Grafik Butonu (isteÄŸe baÄŸlÄ±, auto-load olduÄŸu iÃ§in) */
        #chart-button {
            padding: 12px 25px; 
            background-color: #3498db; 
            color: white; 
            border: none; 
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-size: 17px;
            transition: background-color 0.2s;
            box-shadow: 0 4px #2980b9;
        }
        #chart-button:active {
            box-shadow: 0 1px #2980b9;
            transform: translateY(3px);
        }

        .chart-container { 
            width: 95%;
            max-width: 1000px; 
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        #current-cumulative-value { 
            font-size: 24px; 
            font-weight: bold; 
            margin-top: 15px; 
            text-align: center;
            color: #e74c3c; 
            padding: 10px;
            border: 2px dashed #e74c3c;
            border-radius: 8px;
        }
        input[type="date"] { 
            padding: 10px; 
            font-size: 16px; 
            border: 1px solid #ccc;
            border-radius: 6px;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 15px;
        }
        #selected-value {
            font-size: 20px;
            color: #2980b9;
            display: block;
            margin-bottom: 15px;
        }

        /* Mobil Uyumlu TasarÄ±m */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            .data-section {
                width: 100%;
                max-width: none;
            }
            .chart-container {
                width: 100%;
            }
        }
    </style>
</head>
<body>

    <h1>ðŸ“… KÃ¼mÃ¼latif Veri Kaydedici</h1>

    <div class="container">
        <!-- Veri GiriÅŸi BÃ¶lÃ¼mÃ¼ -->
        <div class="data-section">
            <h3>Veri GiriÅŸi</h3>
            <label for="date-picker" style="font-weight: bold;">Tarih SeÃ§in:</label>
            <input type="date" id="date-picker" required>

            <span style="display: block; font-weight: bold;">SeÃ§ilen DeÄŸer:</span> 
            <strong id="selected-value">0.00</strong>

            <div class="button-grid" id="button-container">
                <!-- Butonlar JavaScript ile doldurulacak -->
            </div>
            
            <button id="save-button" onclick="saveData()">
                ðŸ’¾ SeÃ§ilen DeÄŸeri Kaydet
            </button>
            <p id="save-status" style="color: #27ae60; font-weight: bold; text-align: center; margin-top: 10px;"></p>
        </div>
        
        <!-- Grafik Ä°ÅŸlemleri BÃ¶lÃ¼mÃ¼ -->
        <div class="data-section">
            <h3>Grafik & Analiz</h3>
            <button id="chart-button" onclick="generateChart()">
                ðŸ“ˆ GrafiÄŸi Åžimdi GÃ¼ncelle
            </button>
            <div id="current-cumulative-value"></div>
            <p style="margin-top: 20px; color: #7f8c8d; font-size: 14px;">
                SayfayÄ± her aÃ§tÄ±ÄŸÄ±nÄ±zda veriler Firebase'den otomatik Ã§ekilir.
            </p>
        </div>
    </div>

    <!-- Grafik GÃ¶sterim AlanÄ± -->
    <div class="chart-container">
        <canvas id="cumulativeChart"></canvas>
    </div>

    <script>
        // --- 1. YAPILANDIRMA VE BAÅžLANGIÃ‡ ---

        // !!! LÃœTFEN BURAYI KENDÄ° FIREBASE BÄ°LGÄ°LERÄ°NÄ°ZLE DEÄžÄ°ÅžTÄ°RÄ°NÄ°Z !!!
        const firebaseConfig = {
            apiKey: "AIzaSyAIGzwmEB9F7K7KQzsEU5etVWejZ3oSluc",
            authDomain: "paralayici.firebaseapp.com",
            projectId: "paralayici",
            storageBucket: "paralayici.firebasestorage.app",
            messagingSenderId: "980843550614",
            appId: "1:980843550614:web:93dd5bda4ddc377b20efb7"
        };
        
        let db;
        let chartInstance = null; // Grafik Ã¶rneÄŸini tutar

        // Butonlara atanacak deÄŸerler (3 satÄ±r x 3 sÃ¼tun)
        const buttonValues = [
            -1.25, -0.25, 0.75,
            -1, 0, 1,
            -0.75, 0.25, 1.25
        ];

        let selectedValue = 0; // GÃ¼ncel seÃ§ilen deÄŸeri tutar
        const collectionName = "cumulative_daily_data"; // Firestore Koleksiyon AdÄ±

        // Firebase uygulamasÄ±nÄ± baÅŸlat
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log("Firebase baÅŸarÄ±yla baÅŸlatÄ±ldÄ±.");

            // Tarih seÃ§iciyi bugÃ¼nÃ¼n tarihine ayarla
            document.getElementById('date-picker').valueAsDate = new Date();

        } catch (e) {
            console.error("Firebase baÅŸlatÄ±lÄ±rken kritik hata:", e);
            document.body.innerHTML = "<h1>Hata</h1><p>Firebase yapÄ±landÄ±rma bilgileri yanlÄ±ÅŸ veya eksik. LÃ¼tfen `index.html` dosyasÄ±ndaki `firebaseConfig` bÃ¶lÃ¼mÃ¼nÃ¼ kontrol edin.</p>";
        }


        // --- 2. BUTON VE DEÄžER YÃ–NETÄ°MÄ° ---

        function setupButtons() {
            const container = document.getElementById('button-container');
            container.innerHTML = ''; // Temizle
            buttonValues.forEach(value => {
                const button = document.createElement('button');
                button.textContent = value.toFixed(2); // DeÄŸerleri iki ondalÄ±k basamakla gÃ¶ster
                button.onclick = () => selectValue(value);
                container.appendChild(button);
            });
        }

        function selectValue(value) {
            selectedValue = value;
            document.getElementById('selected-value').textContent = value.toFixed(2);
        }

        // Basit uyarÄ± mesajÄ± gÃ¶sterici (alert() yerine)
        function alertMessage(message, color) {
            const statusElement = document.getElementById('save-status');
            statusElement.textContent = message;
            statusElement.style.color = color;
            statusElement.style.borderColor = color;
            setTimeout(() => statusElement.textContent = '', 4000);
        }

        // --- 3. VERÄ° KAYDETME (FIRESTORE) ---

        async function saveData() {
            if (!db) return alertMessage("Firebase baÅŸlatÄ±lamadÄ±.", 'red');

            const dateInput = document.getElementById('date-picker');
            const date = dateInput.value; // YYYY-MM-DD formatÄ±nda tarih (Belge ID'si olarak kullanÄ±lÄ±r)
            
            if (!date) {
                alertMessage("LÃ¼tfen bir tarih seÃ§in.", 'red');
                return;
            }

            try {
                // Tarihi belge kimliÄŸi (Document ID) olarak kullanÄ±yoruz
                await db.collection(collectionName).doc(date).set({
                    date: date,
                    value: selectedValue,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                alertMessage(`âœ… ${date} iÃ§in ${selectedValue.toFixed(2)} kaydedildi!`, 'green');
                
                // KayÄ±t baÅŸarÄ±lÄ± olduktan sonra grafiÄŸi hemen gÃ¼ncelle (Persistance iÃ§in Ã¶nemli)
                generateChart();

            } catch (error) {
                console.error("Veri kaydederken hata oluÅŸtu: ", error);
                alertMessage(`âŒ KayÄ±t hatasÄ±: BaÄŸlantÄ± veya yetkilendirme sorunu.`, 'red');
            }
        }


        // --- 4. GRAFÄ°K OLUÅžTURMA (KÃœMÃœLATÄ°F) ---

        async function generateChart() {
            if (!db) return;

            // Firestore'dan tÃ¼m verileri tarih sÄ±rasÄ±na gÃ¶re Ã§ek
            const snapshot = await db.collection(collectionName)
                                     .orderBy("date", "asc")
                                     .get();
            
            if (snapshot.empty) {
                // Veri yoksa grafiÄŸi temizle ve uyarÄ± gÃ¶ster
                if (chartInstance) chartInstance.destroy();
                document.getElementById('current-cumulative-value').innerHTML = 
                    '**BugÃ¼nkÃ¼ KÃ¼mÃ¼latif DeÄŸer:** 0.00 (Veri Yok)';
                return;
            }

            const allData = [];
            snapshot.forEach(doc => {
                // Veri nesnelerini diziye ekle
                allData.push(doc.data());
            });

            // KÃ¼mÃ¼latif toplamÄ± hesapla
            let cumulativeSum = 0;
            const labels = []; // Tarihler
            const cumulativeData = []; // KÃ¼mÃ¼latif deÄŸerler

            allData.forEach(item => {
                cumulativeSum += item.value;
                labels.push(item.date);
                cumulativeData.push(cumulativeSum);
            });

            // Son kÃ¼mÃ¼latif deÄŸeri gÃ¶ster
            const finalCumulativeValue = cumulativeSum.toFixed(2);
            document.getElementById('current-cumulative-value').innerHTML = 
                `**BugÃ¼nkÃ¼ KÃ¼mÃ¼latif DeÄŸer:** ${finalCumulativeValue}`;


            // Chart.js ile grafik oluÅŸtur veya gÃ¼ncelle
            const ctx = document.getElementById('cumulativeChart').getContext('2d');
            
            // EÄŸer daha Ã¶nce bir grafik varsa, onu yok et
            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'KÃ¼mÃ¼latif DeÄŸer',
                        data: cumulativeData,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.2)',
                        tension: 0.3,
                        fill: true, // AlanÄ± doldursun
                        pointRadius: 5,
                        pointBackgroundColor: '#2ecc71',
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Zamana GÃ¶re KÃ¼mÃ¼latif Veri GeliÅŸimi',
                            font: { size: 18, weight: 'bold' }
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Tarih',
                                font: { size: 14 }
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'KÃ¼mÃ¼latif Toplam',
                                font: { size: 14 }
                            },
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        // --- 5. SAYFA YÃœKLENÄ°NCE OTOMATÄ°K Ä°ÅžLEMLER (PERSISTENCE) ---
        
        window.onload = () => {
            setupButtons();
            // Sayfa aÃ§Ä±ldÄ±ÄŸÄ±nda otomatik olarak verileri Ã§ek ve grafiÄŸi oluÅŸtur
            generateChart(); 
        };
    </script>

</body>
</html>
