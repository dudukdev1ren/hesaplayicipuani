<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finansal Analiz Dashboard v3.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#333;padding:10px;min-height:100vh}
        .header{background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);padding:20px;border-radius:15px;margin-bottom:15px;box-shadow:0 8px 32px rgba(0,0,0,0.1);text-align:center;position:relative}
        .header h1{color:#1976d2;margin-bottom:10px;font-size:24px;background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .status{padding:8px 15px;border-radius:20px;font-size:12px;margin:10px 0;display:inline-block}
        .status.connected{background:#4caf50;color:white}.status.error{background:#f44336;color:white}.status.loading{background:#ff9800;color:white}
        .status-indicator{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:8px;animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
        .login-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:1000}
        .login-box{background:white;padding:40px;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.3);max-width:400px;width:90%}
        .login-box input{width:100%;padding:15px;margin:15px 0;border:2px solid #ddd;border-radius:10px;font-size:16px;transition:all 0.3s}
        .login-box input:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.1)}
        .login-box button{width:100%;padding:15px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:10px;cursor:pointer;font-size:16px;font-weight:bold;transition:all 0.3s}
        .login-box button:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(102,126,234,0.3)}
        .main-nav{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;margin-bottom:20px}
        .nav-btn{background:rgba(255,255,255,0.9);backdrop-filter:blur(10px);border:2px solid rgba(255,255,255,0.3);padding:15px;border-radius:12px;cursor:pointer;text-align:center;font-weight:bold;transition:all 0.3s;box-shadow:0 4px 15px rgba(0,0,0,0.1)}
        .nav-btn:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,0.2)}
        .nav-btn.active{background:linear-gradient(135deg,#667eea,#764ba2);color:white;box-shadow:0 8px 25px rgba(102,126,234,0.4)}
        .dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:20px}
        .widget{background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);padding:20px;border-radius:15px;box-shadow:0 8px 32px rgba(0,0,0,0.1);border:2px solid rgba(255,255,255,0.3)}
        .widget h3{color:#1976d2;margin-bottom:15px;border-bottom:2px solid rgba(102,126,234,0.2);padding-bottom:8px}
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:15px;margin:15px 0}
        .stat-card{background:linear-gradient(135deg,#f8f9ff,#e8f0fe);padding:15px;border-radius:10px;text-align:center;transition:all 0.3s;position:relative;overflow:hidden}
        .stat-card:hover{transform:translateY(-3px);box-shadow:0 10px 30px rgba(102,126,234,0.2)}
        .stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,#667eea,#764ba2)}
        .stat-value{font-size:24px;font-weight:bold;color:#1976d2;margin-bottom:5px}
        .stat-label{font-size:12px;color:#666;text-transform:uppercase;letter-spacing:0.5px}
        .chart-container{position:relative;height:300px;margin:20px 0}
        .chart-canvas{width:100%!important;height:300px!important}
        .popup{display:none;position:fixed;top:20px;left:20px;right:20px;bottom:20px;background:rgba(255,255,255,0.98);backdrop-filter:blur(20px);border:3px solid rgba(102,126,234,0.3);z-index:2000;overflow-y:auto;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.3)}
        .popup-header{background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:20px;display:flex;justify-content:space-between;align-items:center;border-radius:17px 17px 0 0}
        .popup-content{padding:30px}
        .close-btn{background:#f44336;color:white;border:none;padding:10px 15px;border-radius:8px;cursor:pointer;font-weight:bold;transition:all 0.3s}
        .close-btn:hover{background:#d32f2f;transform:scale(1.05)}
        .date-selector{background:linear-gradient(135deg,#f8f9ff,#e8f0fe);padding:20px;border-radius:12px;margin:20px 0;border:2px solid rgba(102,126,234,0.2)}
        .date-input{width:100%;padding:12px;border:2px solid rgba(102,126,234,0.3);margin:8px 0;border-radius:8px;font-family:inherit;transition:all 0.3s}
        .date-input:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.1)}
        .btn{padding:12px 20px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:8px;cursor:pointer;font-weight:bold;transition:all 0.3s;margin:5px}
        .btn:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(102,126,234,0.3)}
        .btn.secondary{background:linear-gradient(135deg,#f1f2f6,#ddd);color:#333}
        .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:5px;margin:20px 0}
        .calendar-day{padding:12px;text-align:center;border:2px solid rgba(102,126,234,0.2);cursor:pointer;min-height:50px;display:flex;align-items:center;justify-content:center;border-radius:8px;font-size:14px;transition:all 0.3s;background:white}
        .calendar-day:hover{transform:scale(1.05);box-shadow:0 4px 15px rgba(102,126,234,0.2)}
        .calendar-day.selected{background:linear-gradient(135deg,#667eea,#764ba2);color:white}
        .calendar-day.has-data{background:linear-gradient(135deg,#2ed573,#1e90ff);color:white}
        .filter-panel{background:rgba(255,255,255,0.9);padding:20px;border-radius:12px;margin:20px 0;border:2px solid rgba(102,126,234,0.1)}
        .filter-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:15px 0;align-items:center}
        .quick-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:20px 0}
        .trend-indicator{font-size:12px;margin-top:5px}
        .trend-up{color:#4caf50}.trend-down{color:#f44336}.trend-neutral{color:#ff9800}
        .report-section{background:rgba(255,255,255,0.95);padding:20px;margin:20px 0;border-radius:12px;border-left:5px solid #667eea}
        .export-options{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin:20px 0}
        .logout-btn{position:absolute;top:15px;right:15px;background:#f44336;color:white;border:none;padding:8px 12px;border-radius:20px;cursor:pointer;font-size:12px;transition:all 0.3s}
        .logout-btn:hover{background:#d32f2f;transform:scale(1.05)}
        .no-data{text-align:center;padding:50px;color:#999;font-style:italic;background:linear-gradient(135deg,#f8f9ff,#e8f0fe);border-radius:15px}
        .loading{text-align:center;padding:30px;color:#666;background:linear-gradient(135deg,#f8f9ff,#e8f0fe);border-radius:10px}
        .error{background:#ffebee;color:#c62828;padding:15px;border-radius:8px;margin:10px 0;border-left:4px solid #f44336}
        .success{background:#e8f5e8;color:#2e7d32;padding:15px;border-radius:8px;margin:10px 0;border-left:4px solid #4caf50}
        .settings-panel{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px}
        .setting-group{background:rgba(255,255,255,0.9);padding:20px;border-radius:12px;border:2px solid rgba(102,126,234,0.1)}
        .switch-container{display:flex;justify-content:space-between;align-items:center;margin:15px 0;padding:12px;border-bottom:1px solid rgba(102,126,234,0.1)}
        .switch{position:relative;width:60px;height:30px}
        .switch input{opacity:0;width:0;height:0}
        .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#ccc;transition:.4s;border-radius:30px}
        .slider:before{position:absolute;content:"";height:24px;width:24px;left:3px;bottom:3px;background:white;transition:.4s;border-radius:50%}
        input:checked+.slider{background:linear-gradient(135deg,#667eea,#764ba2)}
        input:checked+.slider:before{transform:translateX(30px)}
        @media(max-width:768px){.dashboard-grid{grid-template-columns:1fr}.popup{top:10px;left:10px;right:10px;bottom:10px}.stats-grid{grid-template-columns:repeat(2,1fr)}.filter-row{grid-template-columns:1fr}}
    </style>
</head>
<body>
    <!-- Login Overlay -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-box">
            <h2 style="text-align:center;margin-bottom:30px;color:#667eea">Finansal Dashboard Giri≈ü</h2>
            <input type="email" id="emailInput" placeholder="E-posta adresiniz" autocomplete="email">
            <input type="password" id="passwordInput" placeholder="≈ûifreniz" autocomplete="current-password">
            <div class="error" id="loginError" style="display:none"></div>
            <button onclick="login()">Giri≈ü Yap</button>
            <p style="text-align:center;margin-top:20px;font-size:12px;color:#666">
                Firebase veritabanƒ±nƒ±zdan verileriniz y√ºklenecek
            </p>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" style="display:none">
        <div class="header">
            <button class="logout-btn" onclick="logout()">√áƒ±kƒ±≈ü</button>
            <h1>Finansal Analiz Dashboard v3.0</h1>
            <div id="connectionStatus" class="status loading">
                <span class="status-indicator"></span>Firebase'e baƒülanƒ±yor...
            </div>
            <div style="margin-top:10px;font-size:14px">
                Kullanƒ±cƒ±: <span id="userName">-</span> | 
                Son G√ºncelleme: <span id="lastUpdate">-</span>
            </div>
        </div>

        <div class="main-nav">
            <div class="nav-btn active" onclick="switchView('dashboard')" id="dashboardBtn">Dashboard</div>
            <div class="nav-btn" onclick="switchView('analytics')" id="analyticsBtn">Analitik</div>
            <div class="nav-btn" onclick="switchView('reports')" id="reportsBtn">Raporlar</div>
            <div class="nav-btn" onclick="openDateSelector()">Tarih Se√ß</div>
            <div class="nav-btn" onclick="openSettings()">Ayarlar</div>
            <div class="nav-btn" onclick="exportData()">Dƒ±≈üa Aktar</div>
        </div>

        <div id="contentArea">
            <div class="loading">Veriler y√ºkleniyor...</div>
        </div>
    </div>

    <!-- Date Selection Popup -->
    <div class="popup" id="datePopup">
        <div class="popup-header">
            <h3>Tarih ve Filtre Se√ßenekleri</h3>
            <button class="close-btn" onclick="closeDatePopup()">‚úï</button>
        </div>
        <div class="popup-content">
            <div class="filter-panel">
                <h4>Hƒ±zlƒ± Se√ßim</h4>
                <div class="filter-row">
                    <button class="btn secondary" onclick="selectPeriod('today')">Bug√ºn</button>
                    <button class="btn secondary" onclick="selectPeriod('week')">Bu Hafta</button>
                    <button class="btn secondary" onclick="selectPeriod('month')">Bu Ay</button>
                    <button class="btn secondary" onclick="selectPeriod('quarter')">Bu √áeyrek</button>
                    <button class="btn secondary" onclick="selectPeriod('year')">Bu Yƒ±l</button>
                    <button class="btn secondary" onclick="selectPeriod('all')">T√ºm Veriler</button>
                </div>
            </div>

            <div class="filter-panel">
                <h4>Manuel Tarih Aralƒ±ƒüƒ±</h4>
                <div class="filter-row">
                    <div>
                        <label>Ba≈ülangƒ±√ß:</label>
                        <input type="date" id="startDate" class="date-input">
                    </div>
                    <div>
                        <label>Biti≈ü:</label>
                        <input type="date" id="endDate" class="date-input">
                    </div>
                    <button class="btn" onclick="applyDateRange()">Uygula</button>
                </div>
            </div>

            <div class="filter-panel">
                <h4>Takvim G√∂r√ºn√ºm√º</h4>
                <div class="filter-row">
                    <select id="calendarMonth" class="date-input"></select>
                    <select id="calendarYear" class="date-input"></select>
                    <button class="btn secondary" onclick="updateCalendar()">Takvimi G√ºncelle</button>
                </div>
                <div id="calendarContainer"></div>
            </div>
        </div>
    </div>

    <!-- Settings Popup -->
    <div class="popup" id="settingsPopup">
        <div class="popup-header">
            <h3>Dashboard Ayarlarƒ±</h3>
            <button class="close-btn" onclick="closeSettings()">‚úï</button>
        </div>
        <div class="popup-content">
            <div class="settings-panel">
                <div class="setting-group">
                    <h4>Widget Ayarlarƒ±</h4>
                    <div class="switch-container">
                        <span>G√ºnl√ºk ƒ∞statistikler</span>
                        <label class="switch"><input type="checkbox" id="dailyStats" checked><span class="slider"></span></label>
                    </div>
                    <div class="switch-container">
                        <span>Harcama Grafikleri</span>
                        <label class="switch"><input type="checkbox" id="expenseCharts" checked><span class="slider"></span></label>
                    </div>
                    <div class="switch-container">
                        <span>√áalƒ±≈üma Analizi</span>
                        <label class="switch"><input type="checkbox" id="workAnalysis" checked><span class="slider"></span></label>
                    </div>
                    <div class="switch-container">
                        <span>Trend G√∂stergeleri</span>
                        <label class="switch"><input type="checkbox" id="trendIndicators" checked><span class="slider"></span></label>
                    </div>
                </div>

                <div class="setting-group">
                    <h4>Grafik Ayarlarƒ±</h4>
                    <div class="switch-container">
                        <span>Animasyonlu Grafikler</span>
                        <label class="switch"><input type="checkbox" id="animatedCharts" checked><span class="slider"></span></label>
                    </div>
                    <div class="switch-container">
                        <span>3D Efektler</span>
                        <label class="switch"><input type="checkbox" id="3dEffects"><span class="slider"></span></label>
                    </div>
                    <div class="switch-container">
                        <span>Koyu Tema</span>
                        <label class="switch"><input type="checkbox" id="darkTheme"><span class="slider"></span></label>
                    </div>
                </div>

                <div class="setting-group">
                    <h4>Bildirim Ayarlarƒ±</h4>
                    <div class="switch-container">
                        <span>Otomatik Yenileme</span>
                        <label class="switch"><input type="checkbox" id="autoRefresh" checked><span class="slider"></span></label>
                    </div>
                    <div class="switch-container">
                        <span>Ses Bildirimleri</span>
                        <label class="switch"><input type="checkbox" id="soundNotifications"><span class="slider"></span></label>
                    </div>
                </div>
            </div>
            <div style="margin-top:30px;text-align:center">
                <button class="btn" onclick="saveSettings()">Ayarlarƒ± Kaydet</button>
                <button class="btn secondary" onclick="resetSettings()">Varsayƒ±lanlara D√∂n</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAIGzwmEB9F7K7KQzsEU5etVWejZ3oSluc",
            authDomain: "paralayici.firebaseapp.com",
            projectId: "paralayici",
            storageBucket: "paralayici.firebasestorage.app",
            messagingSenderId: "980843550614",
            appId: "1:980843550614:web:93dd5bda4ddc377b20efb7"
        };

        // Global variables
        let db;
        let currentUser = null;
        let userData = {};
        let filteredData = {};
        let selectedDates = [];
        let currentView = 'dashboard';
        let charts = {};
        let settings = {
            dailyStats: true,
            expenseCharts: true,
            workAnalysis: true,
            trendIndicators: true,
            animatedCharts: true,
            '3dEffects': false,
            darkTheme: false,
            autoRefresh: true,
            soundNotifications: false
        };

        // Firebase initialization
        function initializeFirebase() {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                console.log('‚úÖ Firebase ba≈üarƒ±yla baƒülandƒ±');
                updateConnectionStatus('connected');
            } catch (error) {
                console.error('‚ùå Firebase baƒülantƒ± hatasƒ±:', error);
                updateConnectionStatus('error');
            }
        }

        // Login functions
        async function login() {
            const email = document.getElementById('emailInput').value.trim();
            const password = document.getElementById('passwordInput').value.trim();
            
            if (!email || !password) {
                showLoginError('E-posta ve ≈üifre gerekli!');
                return;
            }
            
            try {
                updateConnectionStatus('loading');
                
                const usersSnapshot = await db.collection('users')
                    .where('email', '==', email)
                    .where('password', '==', password)
                    .get();
                
                if (usersSnapshot.empty) {
                    showLoginError('E-posta veya ≈üifre hatalƒ±!');
                    return;
                }
                
                const userDoc = usersSnapshot.docs[0];
                currentUser = { uid: userDoc.id, ...userDoc.data() };
                
                showMainApp();
                await loadUserData();
                selectPeriod('month'); // Default to current month
                
            } catch (error) {
                console.error('Login error:', error);
                showLoginError('Baƒülantƒ± hatasƒ±!');
            }
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function logout() {
            if (confirm('√áƒ±kƒ±≈ü yapmak istediƒüinizden emin misiniz?')) {
                currentUser = null;
                userData = {};
                filteredData = {};
                selectedDates = [];
                
                // Destroy all charts
                Object.values(charts).forEach(chart => {
                    if (chart && chart.destroy) chart.destroy();
                });
                charts = {};
                
                document.getElementById('loginOverlay').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('emailInput').value = '';
                document.getElementById('passwordInput').value = '';
                document.getElementById('loginError').style.display = 'none';
            }
        }

        function showMainApp() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('userName').textContent = currentUser.username || currentUser.email;
            updateConnectionStatus('connected');
            loadSettings();
        }

        // Data loading functions
        async function loadUserData() {
            if (!currentUser || !db) return;
            
            try {
                updateConnectionStatus('loading');
                
                const dailySnapshot = await db.collection('users')
                    .doc(currentUser.uid)
                    .collection('daily')
                    .get({ source: 'server' });
                
                userData = {};
                dailySnapshot.forEach(doc => {
                    userData[doc.id] = doc.data();
                });
                
                console.log(`‚úÖ ${Object.keys(userData).length} g√ºnl√ºk veri y√ºklendi`);
                updateConnectionStatus('connected');
                updateLastUpdate();
                
            } catch (error) {
                console.error('‚ùå Veri y√ºkleme hatasƒ±:', error);
                updateConnectionStatus('error');
            }
        }

        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            const indicator = statusElement.querySelector('.status-indicator');
            
            switch(status) {
                case 'connected':
                    statusElement.className = 'status connected';
                    statusElement.innerHTML = '<span class="status-indicator"></span>‚úÖ Firebase Baƒülƒ± - Canlƒ± Veri';
                    break;
                case 'error':
                    statusElement.className = 'status error';
                    statusElement.innerHTML = '<span class="status-indicator"></span>‚ùå Firebase Baƒülantƒ± Hatasƒ±';
                    break;
                case 'loading':
                    statusElement.className = 'status loading';
                    statusElement.innerHTML = '<span class="status-indicator"></span>üîÑ Veriler y√ºkleniyor...';
                    break;
            }
        }

        function updateLastUpdate() {
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('tr-TR');
        }

        // View switching
        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(view + 'Btn').classList.add('active');
            updateContentArea();
        }

        function updateContentArea() {
            const contentArea = document.getElementById('contentArea');
            
            if (Object.keys(filteredData).length === 0) {
                contentArea.innerHTML = '<div class="no-data">üìä Tarih aralƒ±ƒüƒ± se√ßerek analizi ba≈ülatƒ±n</div>';
                return;
            }
            
            switch(currentView) {
                case 'dashboard':
                    contentArea.innerHTML = generateDashboard();
                    renderDashboardCharts();
                    break;
                case 'analytics':
                    contentArea.innerHTML = generateAnalytics();
                    renderAnalyticsCharts();
                    break;
                case 'reports':
                    contentArea.innerHTML = generateReports();
                    break;
            }
        }

        // Date selection functions
        function selectPeriod(period) {
            const today = new Date();
            let startDate, endDate;
            
            switch(period) {
                case 'today':
                    startDate = endDate = today;
                    break;
                case 'week':
                    startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate() - today.getDay());
                    endDate = today;
                    break;
                case 'month':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = today;
                    break;
                case 'quarter':
                    const quarter = Math.floor(today.getMonth() / 3);
                    startDate = new Date(today.getFullYear(), quarter * 3, 1);
                    endDate = today;
                    break;
                case 'year':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = today;
                    break;
                case 'all':
                    const allDates = Object.keys(userData).map(d => new Date(d)).sort();
                    if (allDates.length > 0) {
                        startDate = allDates[0];
                        endDate = allDates[allDates.length - 1];
                    } else {
                        startDate = endDate = today;
                    }
                    break;
            }
            
            filterDataByDateRange(startDate, endDate);
            closeDatePopup();
        }

        function filterDataByDateRange(startDate, endDate) {
            const start = formatDateStr(startDate);
            const end = formatDateStr(endDate);
            
            filteredData = {};
            selectedDates = [];
            
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateStr = formatDateStr(d);
                selectedDates.push(dateStr);
                if (userData[dateStr]) {
                    filteredData[dateStr] = userData[dateStr];
                }
            }
            
            updateContentArea();
        }

        function applyDateRange() {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            
            if (!startDate || !endDate) {
                alert('Ba≈ülangƒ±√ß ve biti≈ü tarihlerini se√ßiniz!');
                return;
            }
            
            if (startDate > endDate) {
                alert('Ba≈ülangƒ±√ß tarihi biti≈ü tarihinden sonra olamaz!');
                return;
            }
            
            filterDataByDateRange(startDate, endDate);
            closeDatePopup();
        }

        // Dashboard generation
        function generateDashboard() {
            const stats = calculateStats();
            
            return `
                <div class="dashboard-grid">
                    ${settings.dailyStats ? generateStatsWidget(stats) : ''}
                    ${settings.expenseCharts ? generateExpenseWidget(stats) : ''}
                    ${settings.workAnalysis ? generateWorkWidget(stats) : ''}
                    ${settings.trendIndicators ? generateTrendWidget(stats) : ''}
                </div>
                
                <div class="quick-stats">
                    <div class="stat-card">
                        <div class="stat-value">${selectedDates.length}</div>
                        <div class="stat-label">Analiz Edilen G√ºn</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.workDays}</div>
                        <div class="stat-label">√áalƒ±≈üma G√ºn√º</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.totalWorkHours.toFixed(1)}</div>
                        <div class="stat-label">Toplam √áalƒ±≈üma</div>
                        <div class="trend-indicator ${getTrendClass(stats.workTrend)}">
                            ${stats.workTrend > 0 ? '‚Üó' : stats.workTrend < 0 ? '‚Üò' : '‚Üí'} ${Math.abs(stats.workTrend).toFixed(1)}%
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.totalExpenses.toFixed(0)}‚Ç∫</div>
                        <div class="stat-label">Toplam Harcama</div>
                        <div class="trend-indicator ${getTrendClass(stats.expenseTrend)}">
                            ${stats.expenseTrend > 0 ? '‚Üó' : stats.expenseTrend < 0 ? '‚Üò' : '‚Üí'} ${Math.abs(stats.expenseTrend).toFixed(1)}%
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.avgDailyExpense.toFixed(0)}‚Ç∫</div>
                        <div class="stat-label">G√ºnl√ºk Ortalama</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.efficiency.toFixed(1)}%</div>
                        <div class="stat-label">Verimlilik Skoru</div>
                        <div class="trend-indicator ${getEfficiencyClass(stats.efficiency)}">
                            ${getEfficiencyText(stats.efficiency)}
                        </div>
                    </div>
                </div>
            `;
        }

        function generateStatsWidget(stats) {
            return `
                <div class="widget">
                    <h3>üìä G√ºnl√ºk ƒ∞statistikler</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${stats.avgWorkHours.toFixed(1)}h</div>
                            <div class="stat-label">Ortalama √áalƒ±≈üma</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${stats.avgDailyExpense.toFixed(0)}‚Ç∫</div>
                            <div class="stat-label">Ortalama Harcama</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${stats.bestDay.hours.toFixed(1)}h</div>
                            <div class="stat-label">En ƒ∞yi G√ºn</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${(stats.totalExpenses / stats.totalWorkHours).toFixed(0)}‚Ç∫</div>
                            <div class="stat-label">Saat Ba≈üƒ±</div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="dailyChart" class="chart-canvas"></canvas>
                    </div>
                </div>
            `;
        }

        function generateExpenseWidget(stats) {
            return `
                <div class="widget">
                    <h3>üí∞ Harcama Analizi</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${stats.categories.essential.toFixed(0)}‚Ç∫</div>
                            <div class="stat-label">Zaruri</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${stats.categories.need.toFixed(0)}‚Ç∫</div>
                            <div class="stat-label">ƒ∞htiya√ß</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${stats.categories.want.toFixed(0)}‚Ç∫</div>
                            <div class="stat-label">ƒ∞stek</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${stats.categories.loss.toFixed(0)}‚Ç∫</div>
                            <div class="stat-label">Kayƒ±p</div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="expenseChart" class="chart-canvas"></canvas>
                    </div>
                </div>
            `;
        }

        function generateWorkWidget(stats) {
            return `
                <div class="widget">
                    <h3>‚ö° √áalƒ±≈üma Analizi</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${stats.productiveDays}</div>
                            <div class="stat-label">Verimli G√ºn</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${stats.overtimeDays}</div>
                            <div class="stat-label">Fazla Mesai</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${stats.shortDays}</div>
                            <div class="stat-label">Kƒ±sa G√ºn</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${stats.holidayDays}</div>
                            <div class="stat-label">Tatil</div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="workChart" class="chart-canvas"></canvas>
                    </div>
                </div>
            `;
        }

        function generateTrendWidget(stats) {
            return `
                <div class="widget">
                    <h3>üìà Trend Analizi</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value ${getTrendClass(stats.workTrend)}">${stats.workTrend > 0 ? '‚Üó' : stats.workTrend < 0 ? '‚Üò' : '‚Üí'}</div>
                            <div class="stat-label">√áalƒ±≈üma Trendi</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value ${getTrendClass(stats.expenseTrend)}">${stats.expenseTrend > 0 ? '‚Üó' : stats.expenseTrend < 0 ? '‚Üò' : '‚Üí'}</div>
                            <div class="stat-label">Harcama Trendi</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${stats.consistency.toFixed(1)}%</div>
                            <div class="stat-label">Tutarlƒ±lƒ±k</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${stats.balance.toFixed(1)}%</div>
                            <div class="stat-label">Denge</div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="trendChart" class="chart-canvas"></canvas>
                    </div>
                </div>
            `;
        }

        function generateAnalytics() {
            const stats = calculateDetailedStats();
            
            return `
                <div class="report-section">
                    <h3>üîç Detaylƒ± Analitik Rapor</h3>
                    <p>Se√ßili d√∂nem: ${formatDate(selectedDates[0])} - ${formatDate(selectedDates[selectedDates.length - 1])}</p>
                </div>
                
                <div class="dashboard-grid">
                    <div class="widget">
                        <h3>üìä Haftalƒ±k Performans</h3>
                        <div class="chart-container">
                            <canvas id="weeklyChart" class="chart-canvas"></canvas>
                        </div>
                    </div>
                    
                    <div class="widget">
                        <h3>üíπ Harcama Daƒüƒ±lƒ±mƒ±</h3>
                        <div class="chart-container">
                            <canvas id="distributionChart" class="chart-canvas"></canvas>
                        </div>
                    </div>
                    
                    <div class="widget">
                        <h3>‚ö° Verimlilik Haritasƒ±</h3>
                        <div class="chart-container">
                            <canvas id="heatmapChart" class="chart-canvas"></canvas>
                        </div>
                    </div>
                    
                    <div class="widget">
                        <h3>üìà Korelasyon Analizi</h3>
                        <div class="chart-container">
                            <canvas id="correlationChart" class="chart-canvas"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="report-section">
                    <h4>üéØ √ñnemli Bulgular</h4>
                    <ul>
                        <li><strong>En Verimli G√ºn:</strong> ${stats.insights.mostProductiveDay}</li>
                        <li><strong>En Y√ºksek Harcama:</strong> ${stats.insights.highestExpenseDay}</li>
                        <li><strong>Optimal √áalƒ±≈üma Saati:</strong> ${stats.insights.optimalWorkHours} saat</li>
                        <li><strong>Harcama Paterni:</strong> ${stats.insights.spendingPattern}</li>
                        <li><strong>Verimlilik Fakt√∂r√º:</strong> ${stats.insights.productivityFactor}</li>
                    </ul>
                </div>
            `;
        }

        function generateReports() {
            const stats = calculateStats();
            
            return `
                <div class="report-section">
                    <h3>üìã Kapsamlƒ± Finansal Rapor</h3>
                    <div class="export-options">
                        <button class="btn" onclick="exportToPDF()">PDF ƒ∞ndir</button>
                        <button class="btn" onclick="exportToExcel()">Excel ƒ∞ndir</button>
                        <button class="btn secondary" onclick="printReport()">Yazdƒ±r</button>
                    </div>
                </div>
                
                <div class="dashboard-grid">
                    <div class="widget">
                        <h3>üìä √ñzet ƒ∞statistikler</h3>
                        <table style="width:100%;border-collapse:collapse">
                            <tr><td style="padding:8px;border-bottom:1px solid #ddd"><strong>Toplam √áalƒ±≈üma Saati:</strong></td><td style="padding:8px;border-bottom:1px solid #ddd">${stats.totalWorkHours.toFixed(1)} saat</td></tr>
                            <tr><td style="padding:8px;border-bottom:1px solid #ddd"><strong>Toplam Harcama:</strong></td><td style="padding:8px;border-bottom:1px solid #ddd">${stats.totalExpenses.toFixed(2)} ‚Ç∫</td></tr>
                            <tr><td style="padding:8px;border-bottom:1px solid #ddd"><strong>Ortalama G√ºnl√ºk √áalƒ±≈üma:</strong></td><td style="padding:8px;border-bottom:1px solid #ddd">${stats.avgWorkHours.toFixed(1)} saat</td></tr>
                            <tr><td style="padding:8px;border-bottom:1px solid #ddd"><strong>Ortalama G√ºnl√ºk Harcama:</strong></td><td style="padding:8px;border-bottom:1px solid #ddd">${stats.avgDailyExpense.toFixed(2)} ‚Ç∫</td></tr>
                            <tr><td style="padding:8px;border-bottom:1px solid #ddd"><strong>Saat Ba≈üƒ± Harcama:</strong></td><td style="padding:8px;border-bottom:1px solid #ddd">${(stats.totalExpenses/stats.totalWorkHours).toFixed(2)} ‚Ç∫</td></tr>
                            <tr><td style="padding:8px;border-bottom:1px solid #ddd"><strong>Verimlilik Skoru:</strong></td><td style="padding:8px;border-bottom:1px solid #ddd">${stats.efficiency.toFixed(1)}%</td></tr>
                        </table>
                    </div>
                    
                    <div class="widget">
                        <h3>üí∞ Kategori Detaylarƒ±</h3>
                        <div class="chart-container">
                            <canvas id="categoryDetailChart" class="chart-canvas"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="report-section">
                    <h4>üéØ √ñneriler ve Aksiyon Planƒ±</h4>
                    ${generateRecommendations(stats)}
                </div>
            `;
        }

        // Calculation functions
        function calculateStats() {
            let totalWorkHours = 0;
            let totalExpenses = 0;
            let workDays = 0;
            let productiveDays = 0;
            let overtimeDays = 0;
            let shortDays = 0;
            let holidayDays = 0;
            let bestDay = { date: '', hours: 0 };
            
            const categories = { essential: 0, need: 0, want: 0, loss: 0 };
            const dailyData = [];
            
            selectedDates.forEach(dateStr => {
                const data = filteredData[dateStr] || {};
                const workHours = calculateWorkHours(data.workData || {});
                const expenses = calculateDayExpenses(data.expenses || []);
                const isHoliday = data.isHoliday || false;
                
                if (isHoliday) {
                    holidayDays++;
                } else if (workHours > 0) {
                    workDays++;
                    totalWorkHours += workHours;
                    
                    if (workHours > 8) overtimeDays++;
                    else if (workHours > 6) productiveDays++;
                    else if (workHours > 0) shortDays++;
                    
                    if (workHours > bestDay.hours) {
                        bestDay = { date: dateStr, hours: workHours };
                    }
                }
                
                totalExpenses += expenses;
                
                // Category calculations
                (data.expenses || []).forEach(exp => {
                    const category = exp.category || 'need';
                    categories[category] += exp.amount || 0;
                });
                
                dailyData.push({ date: dateStr, workHours, expenses, isHoliday });
            });
            
            const avgWorkHours = workDays > 0 ? totalWorkHours / workDays : 0;
            const avgDailyExpense = selectedDates.length > 0 ? totalExpenses / selectedDates.length : 0;
            
            // Calculate trends (simplified)
            const midPoint = Math.floor(dailyData.length / 2);
            const firstHalf = dailyData.slice(0, midPoint);
            const secondHalf = dailyData.slice(midPoint);
            
            const firstHalfWorkAvg = firstHalf.reduce((sum, d) => sum + d.workHours, 0) / firstHalf.length;
            const secondHalfWorkAvg = secondHalf.reduce((sum, d) => sum + d.workHours, 0) / secondHalf.length;
            const workTrend = firstHalfWorkAvg > 0 ? ((secondHalfWorkAvg - firstHalfWorkAvg) / firstHalfWorkAvg) * 100 : 0;
            
            const firstHalfExpenseAvg = firstHalf.reduce((sum, d) => sum + d.expenses, 0) / firstHalf.length;
            const secondHalfExpenseAvg = secondHalf.reduce((sum, d) => sum + d.expenses, 0) / secondHalf.length;
            const expenseTrend = firstHalfExpenseAvg > 0 ? ((secondHalfExpenseAvg - firstHalfExpenseAvg) / firstHalfExpenseAvg) * 100 : 0;
            
            // Calculate efficiency score
            const necessaryExpenses = categories.essential + categories.need;
            const unnecessaryExpenses = categories.want + categories.loss;
            const spendingEfficiency = totalExpenses > 0 ? (necessaryExpenses / totalExpenses) * 100 : 100;
            const workEfficiency = avgWorkHours > 0 ? Math.min((avgWorkHours / 8) * 100, 100) : 0;
            const efficiency = (spendingEfficiency + workEfficiency) / 2;
            
            const consistency = calculateConsistency(dailyData.map(d => d.workHours));
            const balance = calculateBalance(categories);
            
            return {
                totalWorkHours,
                totalExpenses,
                workDays,
                productiveDays,
                overtimeDays,
                shortDays,
                holidayDays,
                avgWorkHours,
                avgDailyExpense,
                bestDay,
                categories,
                workTrend,
                expenseTrend,
                efficiency,
                consistency,
                balance,
                dailyData
            };
        }

        function calculateDetailedStats() {
            const stats = calculateStats();
            
            // Find insights
            const insights = {
                mostProductiveDay: stats.bestDay.date ? formatDate(stats.bestDay.date) : 'Veri yok',
                highestExpenseDay: findHighestExpenseDay(),
                optimalWorkHours: findOptimalWorkHours(),
                spendingPattern: analyzeSpendingPattern(),
                productivityFactor: calculateProductivityFactor()
            };
            
            return { ...stats, insights };
        }

        function findHighestExpenseDay() {
            let maxExpense = 0;
            let maxDay = '';
            
            selectedDates.forEach(dateStr => {
                const data = filteredData[dateStr] || {};
                const expenses = calculateDayExpenses(data.expenses || []);
                if (expenses > maxExpense) {
                    maxExpense = expenses;
                    maxDay = dateStr;
                }
            });
            
            return maxDay ? formatDate(maxDay) : 'Veri yok';
        }

        function findOptimalWorkHours() {
            const workData = selectedDates.map(dateStr => {
                const data = filteredData[dateStr] || {};
                return {
                    hours: calculateWorkHours(data.workData || {}),
                    expenses: calculateDayExpenses(data.expenses || [])
                };
            }).filter(d => d.hours > 0);
            
            if (workData.length === 0) return '8';
            
            // Find hours with best expense/hour ratio
            const ratios = workData.map(d => ({ hours: d.hours, ratio: d.expenses / d.hours }));
            ratios.sort((a, b) => a.ratio - b.ratio);
            
            return ratios[0].hours.toFixed(1);
        }

        function analyzeSpendingPattern() {
            const stats = calculateStats();
            const total = stats.totalExpenses;
            
            if (total === 0) return 'Harcama verisi yok';
            
            const essentialRatio = stats.categories.essential / total;
            const wantRatio = stats.categories.want / total;
            const lossRatio = stats.categories.loss / total;
            
            if (lossRatio > 0.2) return 'Y√ºksek kayƒ±p harcama riski';
            if (wantRatio > 0.4) return 'ƒ∞stek odaklƒ± harcama';
            if (essentialRatio > 0.6) return 'Ihtiya√ß odaklƒ± harcama';
            return 'Dengeli harcama daƒüƒ±lƒ±mƒ±';
        }

        function calculateProductivityFactor() {
            const stats = calculateStats();
            
            if (stats.totalWorkHours === 0) return '√áalƒ±≈üma verisi yok';
            
            const hourlyExpense = stats.totalExpenses / stats.totalWorkHours;
            
            if (hourlyExpense < 20) return 'Y√ºksek verimlilik';
            if (hourlyExpense < 40) return 'Orta verimlilik';
            return 'D√º≈ü√ºk verimlilik';
        }

        // Chart rendering functions
        function renderDashboardCharts() {
            const stats = calculateStats();
            
            // Daily overview chart
            if (document.getElementById('dailyChart')) {
                const ctx = document.getElementById('dailyChart').getContext('2d');
                if (charts.dailyChart) charts.dailyChart.destroy();
                
                charts.dailyChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: selectedDates.map(formatDate),
                        datasets: [
                            {
                                label: '√áalƒ±≈üma Saati',
                                data: stats.dailyData.map(d => d.workHours),
                                borderColor: '#667eea',
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                yAxisID: 'y'
                            },
                            {
                                label: 'Harcama (‚Ç∫)',
                                data: stats.dailyData.map(d => d.expenses),
                                borderColor: '#f44336',
                                backgroundColor: 'rgba(244, 67, 54, 0.1)',
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: { duration: settings.animatedCharts ? 1000 : 0 },
                        scales: {
                            y: { type: 'linear', display: true, position: 'left' },
                            y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false } }
                        }
                    }
                });
            }
            
            // Expense pie chart
            if (document.getElementById('expenseChart')) {
                const ctx = document.getElementById('expenseChart').getContext('2d');
                if (charts.expenseChart) charts.expenseChart.destroy();
                
                charts.expenseChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Zaruri', 'ƒ∞htiya√ß', 'ƒ∞stek', 'Kayƒ±p'],
                        datasets: [{
                            data: [
                                stats.categories.essential,
                                stats.categories.need,
                                stats.categories.want,
                                stats.categories.loss
                            ],
                            backgroundColor: ['#4caf50', '#2196f3', '#ff9800', '#f44336'],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: { duration: settings.animatedCharts ? 1000 : 0 },
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            }
            
            // Work analysis chart
            if (document.getElementById('workChart')) {
                const ctx = document.getElementById('workChart').getContext('2d');
                if (charts.workChart) charts.workChart.destroy();
                
                charts.workChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: selectedDates.map(formatDate),
                        datasets: [{
                            label: '√áalƒ±≈üma Saatleri',
                            data: stats.dailyData.map(d => d.workHours),
                            backgroundColor: stats.dailyData.map(d => {
                                if (d.workHours > 8) return '#f44336';
                                if (d.workHours > 6) return '#4caf50';
                                if (d.workHours > 0) return '#ff9800';
                                return '#bdbdbd';
                            }),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: { duration: settings.animatedCharts ? 1000 : 0 },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
            
            // Trend chart
            if (document.getElementById('trendChart')) {
                const ctx = document.getElementById('trendChart').getContext('2d');
                if (charts.trendChart) charts.trendChart.destroy();
                
                const weeklyData = groupByWeeks(stats.dailyData);
                
                charts.trendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: weeklyData.map((_, i) => `Hafta ${i + 1}`),
                        datasets: [
                            {
                                label: 'Haftalƒ±k √áalƒ±≈üma',
                                data: weeklyData.map(w => w.totalHours),
                                borderColor: '#667eea',
                                fill: false
                            },
                            {
                                label: 'Haftalƒ±k Harcama',
                                data: weeklyData.map(w => w.totalExpenses),
                                borderColor: '#f44336',
                                fill: false,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: { duration: settings.animatedCharts ? 1000 : 0 },
                        scales: {
                            y: { type: 'linear', display: true, position: 'left' },
                            y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false } }
                        }
                    }
                });
            }
        }

        function renderAnalyticsCharts() {
            // Implementation for advanced analytics charts
            setTimeout(() => {
                const stats = calculateDetailedStats();
                
                if (document.getElementById('weeklyChart')) {
                    renderWeeklyChart(stats);
                }
                if (document.getElementById('distributionChart')) {
                    renderDistributionChart(stats);
                }
                if (document.getElementById('heatmapChart')) {
                    renderHeatmapChart(stats);
                }
                if (document.getElementById('correlationChart')) {
                    renderCorrelationChart(stats);
                }
            }, 100);
        }

        // Utility functions
        function calculateWorkHours(workData) {
            if (!workData.startTime || !workData.endTime) return 0;
            
            try {
                const start = new Date(`2000-01-01T${workData.startTime}`);
                const end = new Date(`2000-01-01T${workData.endTime}`);
                const breakMinutes = workData.breakTime || 0;
                const workMinutes = (end - start) / (1000 * 60) - breakMinutes;
                return Math.max(0, workMinutes / 60);
            } catch {
                return 0;
            }
        }

        function calculateDayExpenses(expenses) {
            return expenses.reduce((total, expense) => total + (expense.amount || 0), 0);
        }

        function calculateConsistency(values) {
            if (values.length === 0) return 0;
            
            const mean = values.reduce((sum, val) => sum + val, 0) / values.length;
            const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;
            const stdDev = Math.sqrt(variance);
            
            return Math.max(0, 100 - (stdDev / mean) * 100);
        }

        function calculateBalance(categories) {
            const total = Object.values(categories).reduce((sum, val) => sum + val, 0);
            if (total === 0) return 100;
            
            const necessary = categories.essential + categories.need;
            return (necessary / total) * 100;
        }

        function groupByWeeks(dailyData) {
            const weeks = [];
            let currentWeek = [];
            
            dailyData.forEach((day, index) => {
                currentWeek.push(day);
                
                if (currentWeek.length === 7 || index === dailyData.length - 1) {
                    weeks.push({
                        totalHours: currentWeek.reduce((sum, d) => sum + d.workHours, 0),
                        totalExpenses: currentWeek.reduce((sum, d) => sum + d.expenses, 0)
                    });
                    currentWeek = [];
                }
            });
            
            return weeks;
        }

        function getTrendClass(trend) {
            if (trend > 5) return 'trend-up';
            if (trend < -5) return 'trend-down';
            return 'trend-neutral';
        }

        function getEfficiencyClass(efficiency) {
            if (efficiency > 80) return 'trend-up';
            if (efficiency > 60) return 'trend-neutral';
            return 'trend-down';
        }

        function getEfficiencyText(efficiency) {
            if (efficiency > 80) return 'Y√ºksek';
            if (efficiency > 60) return 'Orta';
            return 'D√º≈ü√ºk';
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            return new Date(dateStr).toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit' });
        }

        function formatDateStr(date) {
            return date.toISOString().split('T')[0];
        }

        // Additional chart functions
        function renderWeeklyChart(stats) {
            const ctx = document.getElementById('weeklyChart').getContext('2d');
            if (charts.weeklyChart) charts.weeklyChart.destroy();
            
            const weeklyData = groupByWeeks(stats.dailyData);
            
            charts.weeklyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: weeklyData.map((_, i) => `Hafta ${i + 1}`),
                    datasets: [{
                        label: 'Haftalƒ±k Performans',
                        data: weeklyData.map(w => w.totalHours),
                        backgroundColor: 'rgba(102, 126, 234, 0.7)',
                        borderColor: '#667eea',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function renderDistributionChart(stats) {
            const ctx = document.getElementById('distributionChart').getContext('2d');
            if (charts.distributionChart) charts.distributionChart.destroy();
            
            charts.distributionChart = new Chart(ctx, {
                type: 'polarArea',
                data: {
                    labels: ['Zaruri', 'ƒ∞htiya√ß', 'ƒ∞stek', 'Kayƒ±p'],
                    datasets: [{
                        data: [stats.categories.essential, stats.categories.need, stats.categories.want, stats.categories.loss],
                        backgroundColor: ['#4caf50', '#2196f3', '#ff9800', '#f44336'],
                        borderWidth: 2
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function renderHeatmapChart(stats) {
            const ctx = document.getElementById('heatmapChart').getContext('2d');
            if (charts.heatmapChart) charts.heatmapChart.destroy();
            
            charts.heatmapChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Verimlilik Haritasƒ±',
                        data: stats.dailyData.map((d, i) => ({
                            x: i + 1,
                            y: d.workHours,
                            r: Math.max(5, d.expenses / 10)
                        })),
                        backgroundColor: 'rgba(102, 126, 234, 0.6)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'G√ºn' } },
                        y: { title: { display: true, text: '√áalƒ±≈üma Saati' } }
                    }
                }
            });
        }

        function renderCorrelationChart(stats) {
            const ctx = document.getElementById('correlationChart').getContext('2d');
            if (charts.correlationChart) charts.correlationChart.destroy();
            
            charts.correlationChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: '√áalƒ±≈üma vs Harcama',
                        data: stats.dailyData.map(d => ({ x: d.workHours, y: d.expenses })),
                        backgroundColor: 'rgba(102, 126, 234, 0.6)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: '√áalƒ±≈üma Saati' } },
                        y: { title: { display: true, text: 'Harcama (‚Ç∫)' } }
                    }
                }
            });
        }

        // Date and calendar functions
        function openDateSelector() {
            document.getElementById('datePopup').style.display = 'block';
            initializeDateSelectors();
        }

        function closeDatePopup() {
            document.getElementById('datePopup').style.display = 'none';
        }

        function initializeDateSelectors() {
            const monthSelect = document.getElementById('calendarMonth');
            const yearSelect = document.getElementById('calendarYear');
            
            if (monthSelect.children.length === 0) {
                const months = ['Ocak', '≈ûubat', 'Mart', 'Nisan', 'Mayƒ±s', 'Haziran', 'Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k'];
                months.forEach((month, i) => {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = month;
                    monthSelect.appendChild(option);
                });
                
                for (let year = 2020; year <= 2030; year++) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelect.appendChild(option);
                }
                
                const today = new Date();
                monthSelect.value = today.getMonth();
                yearSelect.value = today.getFullYear();
            }
        }

        function updateCalendar() {
            const month = parseInt(document.getElementById('calendarMonth').value);
            const year = parseInt(document.getElementById('calendarYear').value);
            const container = document.getElementById('calendarContainer');
            
            container.innerHTML = createCalendarGrid(month, year);
        }

        function createCalendarGrid(month, year) {
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            let html = '<div class="calendar-grid">';
            const dayNames = ['Paz', 'Pzt', 'Sal', '√áar', 'Per', 'Cum', 'Cmt'];
            
            dayNames.forEach(day => {
                html += `<div style="font-weight:bold;padding:8px;text-align:center">${day}</div>`;
            });
            
            for (let i = 0; i < firstDay; i++) {
                html += '<div></div>';
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                const hasData = userData[dateStr];
                const isSelected = selectedDates.includes(dateStr);
                
                html += `<div class="calendar-day ${hasData ? 'has-data' : ''} ${isSelected ? 'selected' : ''}" onclick="toggleDateSelection('${dateStr}')">${day}</div>`;
            }
            
            return html + '</div>';
        }

        function toggleDateSelection(dateStr) {
            const index = selectedDates.indexOf(dateStr);
            if (index > -1) {
                selectedDates.splice(index, 1);
            } else {
                selectedDates.push(dateStr);
            }
            
            filteredData = {};
            selectedDates.forEach(date => {
                if (userData[date]) {
                    filteredData[date] = userData[date];
                }
            });
            
            updateCalendar();
            updateContentArea();
        }

        // Settings functions
        function openSettings() {
            document.getElementById('settingsPopup').style.display = 'block';
            loadSettingsToUI();
        }

        function closeSettings() {
            document.getElementById('settingsPopup').style.display = 'none';
        }

        function loadSettings() {
            const saved = localStorage.getItem('dashboard_settings');
            if (saved) {
                settings = { ...settings, ...JSON.parse(saved) };
            }
        }

        function loadSettingsToUI() {
            Object.keys(settings).forEach(key => {
                const checkbox = document.getElementById(key);
                if (checkbox) {
                    checkbox.checked = settings[key];
                }
            });
        }

        function saveSettings() {
            Object.keys(settings).forEach(key => {
                const checkbox = document.getElementById(key);
                if (checkbox) {
                    settings[key] = checkbox.checked;
                }
            });
            
            localStorage.setItem('dashboard_settings', JSON.stringify(settings));
            updateContentArea();
            closeSettings();
            
            showNotification('Ayarlar kaydedildi!', 'success');
        }

        function resetSettings() {
            settings = {
                dailyStats: true,
                expenseCharts: true,
                workAnalysis: true,
                trendIndicators: true,
                animatedCharts: true,
                '3dEffects': false,
                darkTheme: false,
                autoRefresh: true,
                soundNotifications: false
            };
            
            localStorage.removeItem('dashboard_settings');
            loadSettingsToUI();
            showNotification('Ayarlar sƒ±fƒ±rlandƒ±!', 'success');
        }

        // Export functions
        function exportData() {
            const options = `
                <div style="text-align:center;padding:20px">
                    <button class="btn" onclick="exportToPDF()" style="margin:10px">PDF ƒ∞ndir</button>
                    <button class="btn" onclick="exportToExcel()" style="margin:10px">Excel ƒ∞ndir</button>
                    <button class="btn secondary" onclick="printReport()" style="margin:10px">Yazdƒ±r</button>
                </div>
            `;
            
            showNotification(options, 'info');
        }

        function exportToPDF() {
            const stats = calculateStats();
            const reportWindow = window.open('', '_blank');
            
            const reportHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Finansal Dashboard Raporu</title>
                    <style>
                        body{font-family:Arial,sans-serif;margin:20px;line-height:1.6}
                        .header{text-align:center;border-bottom:2px solid #1976d2;padding-bottom:10px}
                        table{width:100%;border-collapse:collapse;margin:20px 0}
                        th,td{padding:10px;border:1px solid #ddd;text-align:left}
                        th{background:#f5f5f5}
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Finansal Dashboard Raporu</h1>
                        <p>Kullanƒ±cƒ±: ${currentUser.username || currentUser.email}</p>
                        <p>Tarih: ${new Date().toLocaleDateString('tr-TR')}</p>
                    </div>
                    
                    <h2>√ñzet ƒ∞statistikler</h2>
                    <table>
                        <tr><th>Metrik</th><th>Deƒüer</th></tr>
                        <tr><td>Toplam √áalƒ±≈üma Saati</td><td>${stats.totalWorkHours.toFixed(1)} saat</td></tr>
                        <tr><td>Toplam Harcama</td><td>${stats.totalExpenses.toFixed(2)} ‚Ç∫</td></tr>
                        <tr><td>Ortalama G√ºnl√ºk √áalƒ±≈üma</td><td>${stats.avgWorkHours.toFixed(1)} saat</td></tr>
                        <tr><td>Ortalama G√ºnl√ºk Harcama</td><td>${stats.avgDailyExpense.toFixed(2)} ‚Ç∫</td></tr>
                        <tr><td>Verimlilik Skoru</td><td>${stats.efficiency.toFixed(1)}%</td></tr>
                    </table>
                    
                    <h2>Kategori Daƒüƒ±lƒ±mƒ±</h2>
                    <table>
                        <tr><th>Kategori</th><th>Tutar</th><th>Y√ºzde</th></tr>
                        <tr><td>Zaruri</td><td>${stats.categories.essential.toFixed(2)} ‚Ç∫</td><td>${((stats.categories.essential/stats.totalExpenses)*100).toFixed(1)}%</td></tr>
                        <tr><td>ƒ∞htiya√ß</td><td>${stats.categories.need.toFixed(2)} ‚Ç∫</td><td>${((stats.categories.need/stats.totalExpenses)*100).toFixed(1)}%</td></tr>
                        <tr><td>ƒ∞stek</td><td>${stats.categories.want.toFixed(2)} ‚Ç∫</td><td>${((stats.categories.want/stats.totalExpenses)*100).toFixed(1)}%</td></tr>
                        <tr><td>Kayƒ±p</td><td>${stats.categories.loss.toFixed(2)} ‚Ç∫</td><td>${((stats.categories.loss/stats.totalExpenses)*100).toFixed(1)}%</td></tr>
                    </table>
                </body>
                </html>
            `;
            
            reportWindow.document.write(reportHTML);
            reportWindow.document.close();
            reportWindow.print();
        }

        function exportToExcel() {
            const stats = calculateStats();
            let csvContent = "data:text/csv;charset=utf-8,";
            
            csvContent += "Tarih,√áalƒ±≈üma Saati,Harcama,Zaruri,ƒ∞htiya√ß,ƒ∞stek,Kayƒ±p\n";
            
            selectedDates.forEach(dateStr => {
                const data = filteredData[dateStr] || {};
                const workHours = calculateWorkHours(data.workData || {});
                const expenses = calculateDayExpenses(data.expenses || []);
                const categories = { essential: 0, need: 0, want: 0, loss: 0 };
                
                (data.expenses || []).forEach(exp => {
                    const cat = exp.category || 'need';
                    categories[cat] += exp.amount || 0;
                });
                
                csvContent += `${formatDate(dateStr)},${workHours.toFixed(1)},${expenses.toFixed(2)},${categories.essential.toFixed(2)},${categories.need.toFixed(2)},${categories.want.toFixed(2)},${categories.loss.toFixed(2)}\n`;
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "finansal_rapor.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function printReport() {
            window.print();
        }

        function generateRecommendations(stats) {
            let recommendations = [];
            
            if (stats.avgWorkHours > 9) {
                recommendations.push('<p>‚ö†Ô∏è G√ºnl√ºk 9+ saat √ßalƒ±≈üma s√ºrd√ºr√ºlemez olabilir. ƒ∞≈ü-ya≈üam dengesini g√∂zden ge√ßirin.</p>');
            }
            
            if (stats.categories.loss / stats.totalExpenses > 0.15) {
                recommendations.push('<p>üö® Kayƒ±p harcamalar fazla. Harcama alƒ±≈ükanlƒ±klarƒ±nƒ±zƒ± g√∂zden ge√ßirin.</p>');
            }
            
            if (stats.efficiency > 80) {
                recommendations.push('<p>‚úÖ Verimlilik skorunuz y√ºksek. Bu ≈üekilde devam edin!</p>');
            } else {
                recommendations.push('<p>üìà Verimlilik skorunuzu artƒ±rmak i√ßin √ßalƒ±≈üma saatlerinizi optimize edin.</p>');
            }
            
            if (recommendations.length === 0) {
                recommendations.push('<p>‚úÖ Genel performansƒ±nƒ±z dengeli g√∂r√ºn√ºyor.</p>');
            }
            
            return recommendations.join('');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = type;
            notification.innerHTML = message;
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '9999';
            notification.style.padding = '15px';
            notification.style.borderRadius = '8px';
            notification.style.maxWidth = '300px';
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 5000);
        }

        // Auto refresh
        setInterval(() => {
            if (settings.autoRefresh && currentUser) {
                loadUserData();
            }
        }, 300000); // 5 minutes

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('loginOverlay').style.display !== 'none') {
                if (e.key === 'Enter') login();
                return;
            }
            
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case '1': e.preventDefault(); switchView('dashboard'); break;
                    case '2': e.preventDefault(); switchView('analytics'); break;
                    case '3': e.preventDefault(); switchView('reports'); break;
                    case 'd': e.preventDefault(); openDateSelector(); break;
                    case 's': e.preventDefault(); openSettings(); break;
                    case 'p': e.preventDefault(); exportToPDF(); break;
                }
            }
            
            if (e.key === 'Escape') {
                document.querySelectorAll('.popup').forEach(popup => {
                    popup.style.display = 'none';
                });
            }
        });

        // Click outside to close popups
        document.addEventListener('click', function(e) {
            document.querySelectorAll('.popup').forEach(popup => {
                if (e.target === popup) {
                    popup.style.display = 'none';
                }
            });
        });

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Finansal Dashboard v3.0 ba≈ülatƒ±lƒ±yor...');
            initializeFirebase();
            loadSettings();
            
            // Set default dates
            const today = new Date();
            document.getElementById('startDate').value = formatDateStr(new Date(today.getFullYear(), today.getMonth(), 1));
            document.getElementById('endDate').value = formatDateStr(today);
        });

        // Enter key support for login
        document.getElementById('emailInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') document.getElementById('passwordInput').focus();
        });

        document.getElementById('passwordInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') login();
        });
    </script>
</body>
</html>
